#!/usr/bin/env bash
# ================================================================
# tmux-colors-from-tinty
# ================================================================
# Generates tmux statusbar configuration from current tinty scheme
# Appends to the tmux theme file with color-specific statusbar settings
#
# Note: #{@VAR} syntax only works in format strings, not in direct set commands
# ================================================================

set -euo pipefail

# Get current scheme name
scheme_name=$(tinty current)

# Find the scheme file
scheme_file="$HOME/.local/share/tinted-theming/tinty/repos/schemes/base16/${scheme_name#base16-}.yaml"

if [[ ! -f "$scheme_file" ]]; then
  echo "# Warning: Scheme file not found: $scheme_file" >&2
  exit 1
fi

# Parse colors from YAML using grep and sed
# Extract base00-base0F colors
declare -A colors
while IFS=':' read -r key value; do
  key=$(echo "$key" | tr -d ' ')
  value=$(echo "$value" | tr -d ' "' | tr -d "'")
  colors[$key]="$value"
done < <(grep -E '^\s+base[0-9A-F]{2}:' "$scheme_file")

# Map Base16 colors to semantic names
BG_COLOR="${colors[base00]}"
BG_COLOR_ACTIVE="${colors[base01]}"
LIGHT_GRAY="${colors[base04]}"
SILVER="${colors[base05]}"
BLACK="${colors[base00]}"
RED="${colors[base08]}"
ORANGE="${colors[base09]}"
YELLOW="${colors[base0A]}"
GREEN="${colors[base0B]}"

# Output custom statusbar configuration
cat << EOF

# ================================================================
# CUSTOM STATUSBAR CONFIGURATION (generated by tmux-colors-from-tinty)
# ================================================================
# These settings override the default Base16 statusbar with custom styling

# Status bar background
set-option -g status-style "bg=$BG_COLOR_ACTIVE"

# Session name in status-left
set-option -g status-left " #[fg=$GREEN]  #[bg=$BG_COLOR_ACTIVE]#S  "
set-option -g status-left-length 100

# Window status separator
set-window-option -g window-status-separator "  "

# All Windows (inactive)
set-window-option -g window-status-style "fg=$LIGHT_GRAY,bg=$BG_COLOR_ACTIVE"
set-window-option -g window-status-format "\\\\   #W   /"

# Current Window (active)
set-window-option -g window-status-current-style "fg=$ORANGE,bg=$BLACK,bold"
set-window-option -g window-status-current-format "\\\\   #W   /"

# Last Window Visited
set-window-option -g window-status-last-style "fg=$SILVER,bg=$BG_COLOR"

# Highlight activity in status bar
set-window-option -g window-status-activity-style "fg=$RED,bg=$BG_COLOR"

# CPU/RAM plugin colors
set-option -g @cpu_low_fg_color "#[fg=$GREEN]"
set-option -g @ram_low_fg_color "#[fg=$GREEN]"
set-option -g @cpu_medium_fg_color "#[fg=$YELLOW]"
set-option -g @ram_medium_fg_color "#[fg=$YELLOW]"
set-option -g @cpu_high_fg_color "#[fg=$RED]"
set-option -g @ram_high_fg_color "#[fg=$RED]"

# Status bar right side: CPU | RAM | time | date
set-option -g status-right-length 100
set-option -g status-right "#[bg=$BG_COLOR_ACTIVE]#{cpu_fg_color}CPU:#{cpu_icon} #{ram_fg_color}RAM:#{ram_icon}  #[fg=$LIGHT_GRAY]%I:%M%p  #[fg=$LIGHT_GRAY]%m.%d.%Y"
EOF
