#!/usr/bin/env bash
# ================================================================
# sess - Simple and Fast Tmux Session Manager
# ================================================================
# Manages tmux sessions, tmuxinator projects, and default sessions
# Usage:
#   sess              - Interactive session list (gum)
#   sess <name>       - Create or switch to session
#   sess last         - Switch to last session
#   sess list         - List all sessions with details
#   sess defaults     - Show default sessions
#   sess kill <name>  - Kill a session
# ================================================================

set -euo pipefail

# Configuration
MENU_CONFIG="${XDG_CONFIG_HOME:-$HOME/.config}/menu"
PLATFORM="${PLATFORM:-macos}"
SESSIONS_CONFIG="$MENU_CONFIG/sessions/sessions-$PLATFORM.yml"

# Colors
color_blue() { echo -e "\033[34m$1\033[0m"; }
color_green() { echo -e "\033[32m$1\033[0m"; }
color_yellow() { echo -e "\033[33m$1\033[0m"; }
color_red() { echo -e "\033[31m$1\033[0m"; }

# ================================================================
# HELPER FUNCTIONS
# ================================================================

is_in_tmux() {
  [[ -n "${TMUX:-}" ]]
}

tmux_session_exists() {
  local session="$1"
  tmux has-session -t "$session" 2>/dev/null
}

get_tmux_sessions() {
  tmux list-sessions -F "#{session_name}:#{session_windows}:tmux" 2>/dev/null || true
}

get_tmuxinator_projects() {
  if command -v tmuxinator &>/dev/null; then
    tmuxinator list | tail -n +2 | tr ' ' '\n' | while read -r project; do
      [[ -n "$project" ]] && echo "$project::tmuxinator"
    done
  fi
}

get_default_sessions() {
  if [[ -f "$SESSIONS_CONFIG" ]]; then
    # Extract only top-level session names (not window names)
    # Session names are at indentation level "  - name:" (2 spaces)
    # Window names are at "      - name:" (6 spaces)
    grep "^  - name:" "$SESSIONS_CONFIG" | sed 's/.*name: //' | while read -r name; do
      echo "$name::default"
    done
  fi
}

get_session_info() {
  local session="$1"

  if tmux_session_exists "$session"; then
    local windows
    windows=$(tmux list-windows -t "$session" -F "#{window_name}" 2>/dev/null | wc -l | tr -d ' ')
    echo "active ($windows windows)"
  elif [[ -f "$HOME/.config/tmuxinator/$session.yml" ]]; then
    echo "tmuxinator project"
  elif grep -q "name: $session" "$SESSIONS_CONFIG" 2>/dev/null; then
    echo "default (not started)"
  else
    echo "new session"
  fi
}

# ================================================================
# CORE FUNCTIONS
# ================================================================

list_all_sessions() {
  # Combine all session sources with visual indicators
  local sessions=()

  # Get active tmux sessions - use green circle for active
  while IFS=: read -r name windows _type; do
    [[ -n "$name" ]] && sessions+=("● $name ($windows windows)")
  done < <(get_tmux_sessions)

  # Get tmuxinator projects (not already active) - use gear icon
  # Avoid subshell by using process substitution with while loop
  if command -v tmuxinator &>/dev/null; then
    local tmuxinator_projects
    tmuxinator_projects=$(tmuxinator list | tail -n +2 | tr ' ' '\n')
    while IFS= read -r project; do
      if [[ -n "$project" ]] && ! tmux_session_exists "$project"; then
        sessions+=("⚙ $project (tmuxinator)")
      fi
    done <<< "$tmuxinator_projects"
  fi

  # Get default sessions (not already shown) - use hollow circle for available
  if [[ -f "$SESSIONS_CONFIG" ]]; then
    while IFS=: read -r name _ _type; do
      if [[ -n "$name" ]] && ! tmux_session_exists "$name" && ! grep -q "⚙ $name" <<<"${sessions[@]}"; then
        sessions+=("○ $name (not started)")
      fi
    done < <(get_default_sessions)
  fi

  printf '%s\n' "${sessions[@]}"
}

create_or_switch_session() {
  local session_name="$1"

  # Check if it's a tmuxinator project
  if [[ -f "$HOME/.config/tmuxinator/$session_name.yml" ]]; then
    if is_in_tmux; then
      tmuxinator start "$session_name" --no-attach
      tmux switch-client -t "$session_name"
    else
      tmuxinator start "$session_name"
    fi
    return
  fi

  # Check if it's a default session
  if grep -q "name: $session_name" "$SESSIONS_CONFIG" 2>/dev/null; then
    create_default_session "$session_name"
    return
  fi

  # Regular tmux session
  if tmux_session_exists "$session_name"; then
    # Session exists, switch to it
    if is_in_tmux; then
      tmux switch-client -t "$session_name"
    else
      tmux attach-session -t "$session_name"
    fi
  else
    # Create new session
    if is_in_tmux; then
      tmux new-session -d -s "$session_name"
      tmux switch-client -t "$session_name"
    else
      tmux new-session -s "$session_name"
    fi
  fi
}

create_default_session() {
  local session_name="$1"

  # Extract session config from YAML
  local config
  config=$(awk "/name: $session_name/,/^  - name:/" "$SESSIONS_CONFIG" | sed '$d')

  # Get directory
  local directory
  directory=$(echo "$config" | grep "directory:" | sed 's/.*directory: //' | sed "s|~|$HOME|")

  # Get tmuxinator project if defined
  local tmuxinator_project
  tmuxinator_project=$(echo "$config" | grep "tmuxinator_project:" | sed 's/.*tmuxinator_project: //')

  if [[ -n "$tmuxinator_project" && "$tmuxinator_project" != "null" ]]; then
    # Use tmuxinator
    if is_in_tmux; then
      tmuxinator start "$tmuxinator_project" --no-attach
      tmux switch-client -t "$tmuxinator_project"
    else
      tmuxinator start "$tmuxinator_project"
    fi
  else
    # Create simple session
    if is_in_tmux; then
      tmux new-session -d -s "$session_name" -c "$directory"
      tmux switch-client -t "$session_name"
    else
      tmux new-session -s "$session_name" -c "$directory"
    fi
  fi
}

switch_to_last_session() {
  if ! is_in_tmux; then
    echo "$(color_red "Error:") Not in tmux"
    exit 1
  fi

  tmux switch-client -l
}

kill_session() {
  local session_name="$1"

  if ! tmux_session_exists "$session_name"; then
    echo "$(color_red "Error:") Session '$session_name' does not exist"
    exit 1
  fi

  tmux kill-session -t "$session_name"
  echo "$(color_green "✓") Killed session: $session_name"
}

show_defaults() {
  if [[ ! -f "$SESSIONS_CONFIG" ]]; then
    echo "$(color_red "Error:") No default sessions configured"
    exit 1
  fi

  echo "Default Sessions ($PLATFORM):"
  echo ""

  while IFS= read -r line; do
    if [[ "$line" =~ ^[[:space:]]*-[[:space:]]*name:[[:space:]]*(.+)$ ]]; then
      local name="${BASH_REMATCH[1]}"
      local desc=$(awk "/name: $name/,/^  - name:/" "$SESSIONS_CONFIG" | grep "description:" | sed 's/.*description: //')
      local status=$(get_session_info "$name")
      echo "  $(color_blue "$name") - $desc"
      echo "    Status: $status"
      echo ""
    fi
  done < "$SESSIONS_CONFIG"
}

interactive_menu() {
  if ! command -v gum &>/dev/null; then
    echo "$(color_red "Error:") gum not found. Install with: brew install gum"
    exit 1
  fi

  local sessions
  sessions=$(list_all_sessions)

  if [[ -z "$sessions" ]]; then
    color_yellow "No sessions found"
    echo ""
    echo "Create a new session with: sess <name>"
    echo "Or check default sessions with: sess defaults"
    exit 0
  fi

  # Add "Create New" option (single newline for separation)
  sessions=$(echo -e "$sessions\n+ Create New Session")

  local choice
  choice=$(echo "$sessions" | gum choose --header="Tmux Sessions")

  if [[ -z "$choice" ]]; then
    exit 0
  fi

  if [[ "$choice" == "+ Create New Session" ]]; then
    local new_name
    new_name=$(gum input --placeholder "Session name")
    [[ -z "$new_name" ]] && exit 0
    create_or_switch_session "$new_name"
  else
    # Extract session name (remove icon and metadata)
    # Format: "● name (info)" or "⚙ name (info)" or "○ name (info)"
    local session_name
    session_name=$(echo "$choice" | sed 's/^[●⚙○] //' | awk '{print $1}')
    create_or_switch_session "$session_name"
  fi
}

# ================================================================
# MAIN
# ================================================================

usage() {
  cat <<EOF
sess - Simple and Fast Tmux Session Manager

Usage:
  sess                - Interactive session list (gum)
  sess <name>         - Create or switch to session
  sess last           - Switch to last session
  sess list           - List all sessions with details
  sess defaults       - Show default sessions
  sess kill <name>    - Kill a session

Examples:
  sess                # Open interactive menu
  sess dotfiles       # Switch to or create 'dotfiles' session
  sess last           # Switch to previous session
  sess kill old-proj  # Kill a session

EOF
}

main() {
  case "${1:-}" in
    "")
      interactive_menu
      ;;
    list)
      list_all_sessions
      ;;
    last)
      switch_to_last_session
      ;;
    defaults)
      show_defaults
      ;;
    kill)
      if [[ -z "${2:-}" ]]; then
        echo "$(color_red "Error:") Session name required"
        echo "Usage: sess kill <session-name>"
        exit 1
      fi
      kill_session "$2"
      ;;
    -h|--help|help)
      usage
      ;;
    *)
      create_or_switch_session "$1"
      ;;
  esac
}

main "$@"
