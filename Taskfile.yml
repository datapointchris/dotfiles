version: '3'

vars:
  DOTFILES_DIR:
    sh: pwd
  PLATFORM:
    sh: |
      if [ -f "$HOME/.env" ]; then
        source "$HOME/.env" && echo "$PLATFORM"
      elif [ "$(uname)" = "Darwin" ]; then
        echo "macos"
      else
        echo "linux"
      fi

includes:
  brew:
    taskfile: ./management/taskfiles/brew.yml
    optional: true
  nvm:
    taskfile: ./management/taskfiles/nvm.yml
    optional: true
  npm:
    taskfile: ./management/taskfiles/npm.yml
    optional: true
  uv:
    taskfile: ./management/taskfiles/uv.yml
    optional: true
  shell:
    taskfile: ./management/taskfiles/shell.yml
    optional: true
  symlinks:
    taskfile: ./management/taskfiles/symlinks.yml
    optional: true
  docs:
    taskfile: ./management/taskfiles/docs.yml
    optional: true
  macos:
    taskfile: ./management/taskfiles/macos.yml
    optional: true
  wsl:
    taskfile: ./management/taskfiles/wsl.yml
    optional: true
  arch:
    taskfile: ./management/taskfiles/arch.yml
    optional: true

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  install:
    desc: Auto-detect platform and install dotfiles
    silent: true
    cmds:
      - |
        case "{{.PLATFORM}}" in
          macos)
            echo "Detected macOS platform"
            task install-macos
            ;;
          linux)
            if grep -q "Microsoft" /proc/version 2>/dev/null; then
              echo "Detected WSL Ubuntu"
              task install-wsl
            elif [ -f /etc/arch-release ]; then
              echo "Detected Arch Linux"
              task install-arch
            else
              echo "Unknown Linux distribution"
              exit 1
            fi
            ;;
          *)
            echo "Unknown platform: {{.PLATFORM}}"
            exit 1
            ;;
        esac

  install-macos:
    desc: Full macOS installation
    silent: true
    cmds:
      - echo "Starting macOS dotfiles installation..."
      - task: brew:install
      - task: nvm:install
      - task: npm:install
      - task: uv:install
      - task: shell:install
      - task: symlinks:link
      - echo "Setting up theme system..."
      - tinty install
      - tinty sync
      - echo "macOS installation complete!"
      - echo ""
      - 'echo "Next steps:"'
      - 'echo "  1. Restart your terminal"'
      - 'echo "  2. Run ''task --list'' to see available commands"'
      - 'echo "  3. Run ''tools list'' to see installed tools"'
      - 'echo "  4. Run ''theme-sync current'' to see current theme"'

  install-wsl:
    desc: Full WSL Ubuntu installation
    silent: true
    cmds:
      - echo "Starting WSL Ubuntu dotfiles installation..."
      - task: wsl:install-packages
      - task: wsl:install-rust
      - task: wsl:install-cargo-tools
      - task: nvm:install
      - task: npm:install
      - task: uv:install
      - task: shell:install
      - task: symlinks:link
      - echo "Setting up theme system..."
      - tinty install
      - tinty sync
      - task: wsl:configure-wsl
      - echo "WSL Ubuntu installation complete!"
      - echo ""
      - 'echo "Next steps:"'
      - 'echo "  1. Restart your terminal"'
      - 'echo "  2. Run ''task --list'' to see available commands"'
      - 'echo "  3. Run ''tools list'' to see installed tools"'
      - 'echo "  4. Run ''theme-sync current'' to see current theme"'
      - echo ""
      - 'echo "Note: If you modified /etc/wsl.conf, restart WSL with: wsl.exe --shutdown"'

  install-arch:
    desc: Full Arch Linux installation
    silent: true
    cmds:
      - echo "Starting Arch Linux dotfiles installation..."
      - task: arch:install-packages
      - task: arch:install-aur-helper
      - task: nvm:install
      - task: npm:install
      - task: uv:install
      - task: shell:install
      - task: symlinks:link
      - echo "Setting up theme system..."
      - tinty install
      - tinty sync
      - task: arch:configure
      - echo "Arch Linux installation complete!"
      - echo ""
      - 'echo "Next steps:"'
      - 'echo "  1. Restart your terminal"'
      - 'echo "  2. Run ''task --list'' to see available commands"'
      - 'echo "  3. Run ''tools list'' to see installed tools"'
      - 'echo "  4. Run ''theme-sync current'' to see current theme"'
