# ================================================================
# NPM Global Packages Management Tasks
# ================================================================
# Manages npm global packages from config/packages.yml
# Requires: nvm and Node.js installed
#
# For simple npm commands, use npm directly:
#   npm list -g --depth=0       # List global packages
#   npm outdated -g             # Check outdated packages
#   npm install -g <package>    # Install a package
#   npm uninstall -g <package>  # Remove a package
#   npm cache clean --force     # Clean cache
#   npm install -g npm@latest   # Update npm itself

version: '3'

vars:
  PACKAGES_CONFIG: "{{.ROOT_DIR}}/config/packages.yml"
  NVM_DIR: "{{.HOME}}/.config/nvm"

tasks:
  # ================================================================
  # INSTALLATION
  # ================================================================

  install:
    desc: Install all npm global packages
    silent: true
    deps:
      - check-config
    cmds:
      - echo "✅ Installing npm global packages..."
      - task: load-nvm
      - |
        export NVM_DIR="{{.NVM_DIR}}"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

        # Language servers
        npm install -g typescript-language-server
        npm install -g typescript
        npm install -g bash-language-server
        npm install -g yaml-language-server
        npm install -g vscode-langservers-extracted
        npm install -g gh-actions-language-server

        # Linters and formatters
        npm install -g eslint
        npm install -g prettier
        npm install -g markdownlint-cli

      - echo "✅ npm global packages installed!"

  # ================================================================
  # UPDATE
  # ================================================================
  # For simple npm commands, use npm directly:
  #   npm update -g                   # Update all global packages
  #   npm outdated -g                 # Check outdated packages
  #   npm install -g npm@latest       # Update npm itself

  # ================================================================
  # HELPERS
  # ================================================================

  load-nvm:
    desc: Load nvm into current shell (helper task)
    internal: true
    silent: true
    cmds:
      - |
        export NVM_DIR="{{.NVM_DIR}}"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

  check-config:
    desc: Check packages.yml exists
    internal: true
    preconditions:
      - sh: test -f {{.PACKAGES_CONFIG}}
        msg: "packages.yml not found at {{.PACKAGES_CONFIG}}"
