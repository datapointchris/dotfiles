# ================================================================
# Shell Plugin Management Tasks
# ================================================================
# Manages ZSH plugins in ~/.config/zsh/plugins
# Plugins defined in config/packages.yml

version: '3'

vars:
  PLUGINS_DIR: "{{.HOME}}/.config/zsh/plugins"
  PACKAGES_CONFIG: "{{.ROOT_DIR}}/config/packages.yml"
  # Shell plugins defined in config/packages.yml under shell_plugins
  # Using yq to read from YAML for single source of truth

tasks:
  # ================================================================
  # INSTALLATION
  # ================================================================

  install:
    desc: Install all shell plugins
    silent: true
    cmds:
      - echo "✅ Installing shell plugins..."
      - |
        # Read plugins from config/packages.yml
        PLUGINS=$(yq eval '.shell_plugins[] | .name + "|" + .repo' {{.PACKAGES_CONFIG}})

        mkdir -p "{{.PLUGINS_DIR}}"

        while IFS='|' read -r name repo; do
          PLUGIN_DIR="{{.PLUGINS_DIR}}/$name"

          if [[ -d "$PLUGIN_DIR" ]]; then
            echo "  $name already installed"
          else
            echo "  Installing $name..."
            git clone "$repo" "$PLUGIN_DIR"
            echo "  $name installed"
          fi
        done <<< "$PLUGINS"

      - echo "✅ All shell plugins installed!"

  # ================================================================
  # UPDATE
  # ================================================================

  update:
    desc: Update all shell plugins
    silent: true
    cmds:
      - echo "✅ Updating shell plugins..."
      - |
        # Read plugins from config/packages.yml
        PLUGINS=$(yq eval '.shell_plugins[].name' {{.PACKAGES_CONFIG}})

        for name in $PLUGINS; do
          PLUGIN_DIR="{{.PLUGINS_DIR}}/$name"

          if [[ -d "$PLUGIN_DIR" ]]; then
            echo "  Updating $name..."
            cd "$PLUGIN_DIR"

            # Get default branch (main or master)
            DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@')
            if [[ -z "$DEFAULT_BRANCH" ]]; then
              DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
            fi

            git pull origin "$DEFAULT_BRANCH"
            echo "  $name updated"
          else
            echo "  $name not installed - skipping"
          fi
        done

      - echo "✅ All shell plugins updated!"

  # ================================================================
  # UTILITIES
  # ================================================================
  # For plugin listing, use ls directly:
  #   ls -1 ~/.config/zsh/plugins
