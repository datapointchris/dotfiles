#!/usr/bin/env bash
# Unified metrics analysis tool for all Claude Code workflows

set -euo pipefail

DOTFILES_DIR="${DOTFILES_DIR:-$HOME/dotfiles}"
METRICS_DIR="$DOTFILES_DIR/.claude/metrics"

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

show_usage() {
    cat << EOF
Usage: analyze-metrics [OPTIONS]

Analyze Claude Code workflow metrics.

OPTIONS:
    -h, --help              Show this help
    -t, --type TYPE         Filter by type (logsift, logsift-auto, commit-agent)
    -d, --date DATE         Show metrics for specific date (YYYY-MM-DD)
    --detailed              Show detailed breakdown
    --summary               Show summary only (default)

EXAMPLES:
    analyze-metrics                           # Summary of all metrics
    analyze-metrics --type commit-agent       # Only commit agent metrics
    analyze-metrics --date 2025-12-04         # Specific date
    analyze-metrics --detailed                # Detailed breakdown

EOF
}

# Parse arguments
TYPE_FILTER=""
DATE_FILTER=""
DETAILED=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_usage
            exit 0
            ;;
        -t|--type)
            TYPE_FILTER="$2"
            shift 2
            ;;
        -d|--date)
            DATE_FILTER="$2"
            shift 2
            ;;
        --detailed)
            DETAILED=true
            shift
            ;;
        --summary)
            DETAILED=false
            shift
            ;;
        *)
            echo "Unknown option: $1"
            show_usage
            exit 1
            ;;
    esac
done

# Check if metrics directory exists
if [[ ! -d "$METRICS_DIR" ]]; then
    echo "No metrics directory found at $METRICS_DIR"
    exit 0
fi

# Find metrics files
if [[ -n "$DATE_FILTER" ]]; then
    METRICS_FILES=("$METRICS_DIR/command-metrics-$DATE_FILTER.jsonl")
else
    mapfile -t METRICS_FILES < <(find "$METRICS_DIR" -name "command-metrics-*.jsonl" -type f | sort)
fi

if [[ ${#METRICS_FILES[@]} -eq 0 ]] || [[ ! -f "${METRICS_FILES[0]}" ]]; then
    echo "No metrics files found"
    echo ""
    echo "Metrics will be collected when you use:"
    echo "  - /logsift or /logsift-auto commands"
    echo "  - Commit agent"
    exit 0
fi

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}   Claude Code Workflow Metrics${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Summary statistics
total_commands=0
logsift_count=0
logsift_auto_count=0
commit_agent_count=0

for file in "${METRICS_FILES[@]}"; do
    [[ -f "$file" ]] || continue

    if [[ -n "$TYPE_FILTER" ]]; then
        file_count=$(grep -c "\"type\": \"$TYPE_FILTER\"" "$file" 2>/dev/null || echo 0)
    else
        file_count=$(wc -l < "$file" 2>/dev/null || echo 0)
    fi

    total_commands=$((total_commands + file_count))

    logsift_count=$((logsift_count + $(grep -c '"type": "logsift"' "$file" || true)))
    logsift_auto_count=$((logsift_auto_count + $(grep -c '"type": "logsift-auto"' "$file" || true)))
    commit_agent_count=$((commit_agent_count + $(grep -c '"type": "commit-agent"' "$file" || true)))
done

echo -e "${GREEN}Total Commands Tracked: $total_commands${NC}"
echo ""
echo "Breakdown by Type:"
echo "  Logsift:       $logsift_count"
echo "  Logsift Auto:  $logsift_auto_count"
echo "  Commit Agent:  $commit_agent_count"
echo ""

# Commit agent specific stats
if [[ "$TYPE_FILTER" == "commit-agent" ]] || [[ -z "$TYPE_FILTER" && $commit_agent_count -gt 0 ]]; then
    echo -e "${BLUE}━━━ Commit Agent Metrics ━━━${NC}"

    for file in "${METRICS_FILES[@]}"; do
        [[ -f "$file" ]] || continue

        # Extract commit agent metrics using Python
        python3 << PYTHON_EOF
import json
import sys

total_commits = 0
total_files = 0
total_tokens = 0
phase_4_count = 0
phase_5_count = 0
read_instructions_count = 0
count = 0

try:
    with open("$file") as f:
        for line in f:
            try:
                entry = json.loads(line)
                if entry.get("type") != "commit-agent":
                    continue

                count += 1
                total_commits += entry.get("commits_created", 0)
                total_files += entry.get("files_committed", 0)
                total_tokens += entry.get("tokens_used", 0)

                if entry.get("phase_4_executed"):
                    phase_4_count += 1
                if entry.get("phase_5_executed"):
                    phase_5_count += 1
                if entry.get("read_own_instructions"):
                    read_instructions_count += 1

            except json.JSONDecodeError:
                continue

    if count > 0:
        print(f"  Total commits created: {total_commits}")
        print(f"  Total files committed: {total_files}")
        print(f"  Average tokens per run: {total_tokens // count:,}")
        print(f"  Phase 4 execution rate: {phase_4_count}/{count} ({100*phase_4_count//count if count > 0 else 0}%)")
        print(f"  Phase 5 execution rate: {phase_5_count}/{count} ({100*phase_5_count//count if count > 0 else 0}%)")
        if read_instructions_count > 0:
            print(f"  ⚠️ Read own instructions: {read_instructions_count} times (should be 0)")

except FileNotFoundError:
    pass
PYTHON_EOF

    done
    echo ""
fi

# Logsift specific stats
if [[ "$TYPE_FILTER" == "logsift" ]] || [[ "$TYPE_FILTER" == "logsift-auto" ]] || [[ -z "$TYPE_FILTER" && $((logsift_count + logsift_auto_count)) -gt 0 ]]; then
    echo -e "${BLUE}━━━ Logsift Metrics ━━━${NC}"

    for file in "${METRICS_FILES[@]}"; do
        [[ -f "$file" ]] || continue

        # Extract logsift metrics using Python
        python3 << PYTHON_EOF
import json

total_errors = 0
total_warnings = 0
successful_runs = 0
failed_runs = 0
count = 0

try:
    with open("$file") as f:
        for line in f:
            try:
                entry = json.loads(line)
                if entry.get("type") not in ["logsift", "logsift-auto"]:
                    continue

                count += 1
                total_errors += entry.get("errors_found", 0)
                total_warnings += entry.get("warnings_found", 0)

                if entry.get("exit_code") == 0:
                    successful_runs += 1
                else:
                    failed_runs += 1

            except json.JSONDecodeError:
                continue

    if count > 0:
        print(f"  Total runs: {count}")
        print(f"  Successful: {successful_runs}")
        print(f"  Failed: {failed_runs}")
        print(f"  Total errors found: {total_errors}")
        print(f"  Total warnings found: {total_warnings}")

except FileNotFoundError:
    pass
PYTHON_EOF

    done
    echo ""
fi

# Recent commands
if [[ "$DETAILED" == true ]]; then
    echo -e "${BLUE}━━━ Recent Commands ━━━${NC}"

    for file in "${METRICS_FILES[@]}"; do
        [[ -f "$file" ]] || continue

        echo "File: $(basename "$file")"

        # Show last 10 entries with formatting
        python3 << 'PYTHON_EOF'
import json
from datetime import datetime
import os

metrics_file = os.environ['file']

with open(metrics_file) as f:
    lines = f.readlines()

for line in lines[-10:]:
    try:
        entry = json.loads(line)
        timestamp = datetime.fromisoformat(entry["timestamp"]).strftime("%H:%M:%S")
        cmd_type = entry["type"]

        if cmd_type == "commit-agent":
            commits = entry.get("commits_created", 0)
            files = entry.get("files_committed", 0)
            tokens = entry.get("tokens_used", 0)
            print(f"  [{timestamp}] commit-agent: {commits} commit(s), {files} files, {tokens:,} tokens")
        elif cmd_type in ["logsift", "logsift-auto"]:
            cmd = entry.get("underlying_command") or entry.get("interpreted_command", "unknown")
            errors = entry.get("errors_found", 0)
            exit_code = entry.get("exit_code", "?")
            print(f"  [{timestamp}] {cmd_type}: '{cmd}' - exit {exit_code}, {errors} errors")
        else:
            print(f"  [{timestamp}] {cmd_type}")

    except (json.JSONDecodeError, KeyError):
        continue
PYTHON_EOF

        echo ""
    done
fi

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
