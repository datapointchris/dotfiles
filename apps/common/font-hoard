#!/usr/bin/env bash
# Font hoard management - deal with the 1,595 font problem
# Help decide what to keep and archive the rest

set -euo pipefail

NEW_FONTS_DIR="$HOME/Documents/new_fonts"
KEEPERS_FILE="$HOME/dotfiles/font-hoard-keepers.txt"
ARCHIVE_DIR="$HOME/Documents/font-archive-$(date +%Y%m%d)"

usage() {
  cat <<EOF
Font hoard management - triage your font collection

Usage: font-hoard <command> [args]

Commands:
  stats               Show statistics about your font collection
  sample [N]          Show N random fonts for quick review (default: 20)
  keep <font>         Mark a font family to keep
  keepers             List fonts marked to keep
  archive             Archive all fonts except keepers
  purge-all           Create archive and remove everything (DESTRUCTIVE)

Workflow:
  1. font-hoard stats                  # See the damage
  2. font-hoard sample 50              # Review random fonts
  3. font-hoard keep "FontName"        # Mark keepers
  4. font-hoard keepers                # Review your keepers
  5. font-hoard archive                # Archive the rest

Or just:
  font-hoard purge-all                 # Archive everything and start fresh

Examples:
  font-hoard sample 20
  font-hoard keep "Helvetica Neue"
  font-hoard archive
EOF
}

# Show statistics
show_stats() {
  if [[ ! -d "$NEW_FONTS_DIR" ]]; then
    echo "Error: $NEW_FONTS_DIR not found"
    exit 1
  fi

  local total_files=$(find "$NEW_FONTS_DIR" -type f \( -name "*.ttf" -o -name "*.otf" \) | wc -l | xargs)
  local total_size=$(du -sh "$NEW_FONTS_DIR" | cut -f1)
  local font_families=$(find "$NEW_FONTS_DIR" -type f \( -name "*.ttf" -o -name "*.otf" \) -exec basename {} \; | sed 's/-.*//; s/\..*//; s/ .*//' | sort -u | wc -l | xargs)

  cat <<STATS
Font Hoard Statistics
━━━━━━━━━━━━━━━━━━━━━

Total font files:     $total_files
Estimated families:   $font_families
Total disk space:     $total_size
Location:             $NEW_FONTS_DIR

Reality Check
━━━━━━━━━━━━━━━━━━━━━

Question: When did you last use a font from new_fonts/?

If the answer is "never" or "I don't remember", consider:
  - Archiving everything: font-hoard purge-all
  - Or at least moving to cold storage

STATS
}

# Show random sample
show_sample() {
  local count="${1:-20}"

  if [[ ! -d "$NEW_FONTS_DIR" ]]; then
    echo "Error: $NEW_FONTS_DIR not found"
    exit 1
  fi

  echo "Random sample of $count fonts from your collection:"
  echo ""

  find "$NEW_FONTS_DIR" -type f \( -name "*.ttf" -o -name "*.otf" \) \
    -exec basename {} \; \
    | sed 's/-.*//; s/\..*//; s/ .*//' \
    | sort -u \
    | shuf -n "$count" \
    | nl

  echo ""
  echo "To mark a keeper: font-hoard keep \"FontName\""
}

# Mark a font to keep
mark_keeper() {
  local font="$1"

  # Initialize keepers file if needed
  touch "$KEEPERS_FILE"

  # Check if already marked
  if grep -Fxq "$font" "$KEEPERS_FILE"; then
    echo "Already marked: $font"
  else
    echo "$font" >> "$KEEPERS_FILE"
    echo "✓ Marked keeper: $font"
  fi
}

# List keepers
list_keepers() {
  if [[ ! -f "$KEEPERS_FILE" ]] || [[ ! -s "$KEEPERS_FILE" ]]; then
    echo "No keepers marked yet"
    echo ""
    echo "Use: font-hoard keep \"FontName\" to mark fonts"
    return
  fi

  echo "Fonts marked to keep:"
  echo ""
  nl "$KEEPERS_FILE"
  echo ""
  echo "Total: $(wc -l < "$KEEPERS_FILE" | xargs) font families"
}

# Archive fonts
archive_fonts() {
  if [[ ! -d "$NEW_FONTS_DIR" ]]; then
    echo "Error: $NEW_FONTS_DIR not found"
    exit 1
  fi

  echo "Creating archive..."
  echo ""

  # Create archive directory
  mkdir -p "$ARCHIVE_DIR"

  # If we have keepers, extract them first
  if [[ -f "$KEEPERS_FILE" ]] && [[ -s "$KEEPERS_FILE" ]]; then
    echo "Extracting keepers..."
    mkdir -p "$ARCHIVE_DIR/../font-keepers"

    while IFS= read -r font; do
      find "$NEW_FONTS_DIR" -type f \( -iname "${font}*.ttf" -o -iname "${font}*.otf" \) \
        -exec cp {} "$ARCHIVE_DIR/../font-keepers/" \; 2>/dev/null || true
    done < "$KEEPERS_FILE"

    echo "✓ Keepers extracted to: $ARCHIVE_DIR/../font-keepers"
  fi

  # Move everything to archive
  echo "Archiving all fonts..."
  mv "$NEW_FONTS_DIR"/* "$ARCHIVE_DIR/" 2>/dev/null || true

  # Compress
  echo "Compressing archive..."
  cd "$HOME/Documents"
  tar -czf "$(basename "$ARCHIVE_DIR").tar.gz" "$(basename "$ARCHIVE_DIR")"

  # Remove uncompressed archive
  rm -rf "$ARCHIVE_DIR"

  echo ""
  echo "✓ Archive created: $HOME/Documents/$(basename "$ARCHIVE_DIR").tar.gz"
  echo "✓ Original directory cleared: $NEW_FONTS_DIR"

  if [[ -f "$KEEPERS_FILE" ]] && [[ -s "$KEEPERS_FILE" ]]; then
    echo "✓ Keepers saved to: $HOME/Documents/font-keepers"
  fi

  echo ""
  echo "Next steps:"
  echo "  1. Move the .tar.gz to external storage or cloud"
  echo "  2. Verify keepers are what you want"
  echo "  3. Delete the local archive when backed up"
  echo "  4. Optionally: rmdir $NEW_FONTS_DIR if empty"
}

# Nuclear option - archive everything
purge_all() {
  if [[ ! -d "$NEW_FONTS_DIR" ]]; then
    echo "Error: $NEW_FONTS_DIR not found"
    exit 1
  fi

  echo "⚠️  WARNING: This will archive ALL fonts in new_fonts/"
  echo ""
  echo "Location: $NEW_FONTS_DIR"
  echo "Archive will be created at: $ARCHIVE_DIR.tar.gz"
  echo ""
  read -r -p "Are you sure? (yes/no): " confirm

  if [[ "$confirm" != "yes" ]]; then
    echo "Cancelled"
    exit 0
  fi

  echo ""
  echo "Creating archive..."
  mkdir -p "$ARCHIVE_DIR"

  echo "Moving fonts..."
  mv "$NEW_FONTS_DIR"/* "$ARCHIVE_DIR/" 2>/dev/null || true

  echo "Compressing..."
  cd "$HOME/Documents"
  tar -czf "$(basename "$ARCHIVE_DIR").tar.gz" "$(basename "$ARCHIVE_DIR")"
  rm -rf "$ARCHIVE_DIR"

  echo ""
  echo "✓ Complete! Archive: $HOME/Documents/$(basename "$ARCHIVE_DIR").tar.gz"
  echo ""
  echo "The archive contains all 1,595 fonts."
  echo "Move it to external storage and delete it when backed up."
  echo ""
  echo "Original directory: $NEW_FONTS_DIR (now empty)"
}

# Main
main() {
  case "${1:-}" in
    stats)
      show_stats
      ;;
    sample)
      show_sample "${2:-20}"
      ;;
    keep)
      if [[ -z "${2:-}" ]]; then
        echo "Error: Font name required"
        usage
        exit 1
      fi
      mark_keeper "$2"
      ;;
    keepers)
      list_keepers
      ;;
    archive)
      archive_fonts
      ;;
    purge-all)
      purge_all
      ;;
    *)
      usage
      exit 1
      ;;
  esac
}

main "$@"
