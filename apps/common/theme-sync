#!/usr/bin/env bash
# ================================================================
# Theme Sync - Base16 Theme Manager
# ================================================================
# Manages Base16 color schemes across multiple applications using tinty
# Supports: tmux, bat, fzf, eza/ls_colors, shell
#
# This works in parallel with your existing ghostty-theme script
# - Use ghostty-theme for Ghostty-specific theme management
# - Use theme-sync for synchronized themes across other apps
# ================================================================

set -euo pipefail

# Source shell libraries
SHELL_DIR="${SHELL_DIR:-$HOME/.local/shell}"
source "$SHELL_DIR/logging.sh"
source "$SHELL_DIR/formatting.sh"

# Your favorite Base16 themes (matching neovim and ghostty favorites)
FAVORITES=(
  "base16-rose-pine"
  "base16-rose-pine-moon"
  "base16-gruvbox-dark-hard"
  "base16-gruvbox-dark-medium"
  "base16-kanagawa"
  "base16-oceanicnext"
  "base16-github-dark"
  "base16-nord"
  "base16-selenized-dark"
  "base16-everforest-dark-hard"
  "base16-tomorrow-night"
  "base16-tomorrow-night-eighties"
)

# ================================================================
# FUNCTIONS
# ================================================================

show_help() {
  print_header "Theme Sync - Base16 Theme Manager" "brightmagenta"
  echo ""
  echo "Manage Base16 color schemes across tmux, bat, fzf, and shell."
  echo ""

  print_section "Commands" "brightcyan"
  echo "  apply <theme>     Apply a Base16 theme"
  echo "  current           Show currently applied theme"
  echo "  list              List all available Base16 themes"
  echo "  favorites         List your favorite themes"
  echo "  info <theme>      Show color palette for a theme"
  echo "  random            Apply a random favorite theme"
  echo "  reload            Reload theme in running applications"
  echo "  verify            Verify theme system is working"
  echo ""

  print_section "Examples" "brightyellow"
  echo "  $(print_cyan "theme-sync apply base16-rose-pine")"
  echo "  $(print_cyan "theme-sync current")"
  echo "  $(print_cyan "theme-sync favorites")"
  echo "  $(print_cyan "theme-sync random")"
  echo ""

  print_section "Quick Theme Shortcuts" "brightgreen"
  echo "  • theme-sync apply base16-rose-pine"
  echo "  • theme-sync apply base16-gruvbox-dark-hard"
  echo "  • theme-sync apply base16-kanagawa"
  echo "  • theme-sync apply base16-nord"
  echo ""

  print_info "This works alongside ghostty-theme for terminal-specific themes"
}

apply_theme() {
  local theme="$1"

  if [[ -z "$theme" ]]; then
    log_error "Theme name required"
    echo "Usage: theme-sync apply <theme-name>"
    exit 1
  fi

  log_info "Applying theme: $theme"

  # Apply theme via tinty
  if ! tinty apply "$theme" 2>&1; then
    log_error "Failed to apply theme"
    echo "Check if theme exists with: theme-sync list"
    exit 1
  fi

  # Reload tmux if running
  if command -v tmux &> /dev/null && tmux list-sessions &> /dev/null 2>&1; then
    tmux source-file ~/.config/tmux/tmux.conf 2>/dev/null || true
    log_success "Tmux reloaded"
  fi

  # Rebuild bat cache
  if command -v bat &> /dev/null; then
    bat cache --build &>/dev/null || true
    log_success "Bat cache rebuilt"
  fi

  log_success "Theme applied: $theme"
}

show_current() {
  local current_file="$HOME/.local/share/tinted-theming/tinty/artifacts/current_scheme"

  if [[ -f "$current_file" ]]; then
    local current=$(cat "$current_file")
    echo "$(print_blue "Current theme:") $current"
  else
    print_yellow "No theme currently applied"
  fi
}

list_themes() {
  print_blue "Available Base16 Themes:"
  echo ""
  tinty list
}

list_favorites() {
  print_blue "Your Favorite Base16 Themes:"
  echo ""
  for theme in "${FAVORITES[@]}"; do
    echo "  $theme"
  done
  echo ""
  echo "Apply with: $(print_yellow "theme-sync apply <theme-name>")"
}

show_info() {
  local theme="$1"

  if [[ -z "$theme" ]]; then
    echo "$(print_red "Error:") Theme name required"
    echo "Usage: theme-sync info <theme-name>"
    exit 1
  fi

  tinty info "$theme"
}

apply_random() {
  local random_theme="${FAVORITES[$RANDOM % ${#FAVORITES[@]}]}"
  echo "$(print_blue "Randomly selected:") $random_theme"
  apply_theme "$random_theme"
}

reload_apps() {
  print_blue "Reloading theme in running applications..."

  # Reload tmux
  if command -v tmux &> /dev/null && tmux list-sessions &> /dev/null 2>&1; then
    tmux source-file ~/.config/tmux/tmux.conf 2>/dev/null && echo "$(print_green "✓") Tmux reloaded"
  fi

  # Rebuild bat cache
  if command -v bat &> /dev/null; then
    bat cache --build &>/dev/null && echo "$(print_green "✓") Bat cache rebuilt"
  fi

  echo "$(print_green "✓") Theme reloaded"
}

verify_system() {
  print_blue "Verifying theme system..."
  echo ""

  # Check tinty installation
  if command -v tinty &> /dev/null; then
    echo "$(print_green "✓") tinty installed"
  else
    echo "$(print_red "✗") tinty not installed"
  fi

  # Check config file
  if [[ -f "$HOME/.config/tinty/config.toml" ]]; then
    echo "$(print_green "✓") tinty config exists"
  else
    echo "$(print_red "✗") tinty config missing"
  fi

  # Check current theme
  local current_file="$HOME/.local/share/tinted-theming/tinty/artifacts/current_scheme"
  if [[ -f "$current_file" ]]; then
    local current=$(cat "$current_file")
    echo "$(print_green "✓") Current theme: $current"
  else
    echo "$(print_yellow "⚠") No theme applied"
  fi

  # Check tmux theme file
  if [[ -f "$HOME/.config/tmux/themes/current.conf" ]]; then
    echo "$(print_green "✓") Tmux theme file exists"
  else
    echo "$(print_red "✗") Tmux theme file missing"
  fi

  # Check bat themes
  if [[ -d "$(bat --config-dir)/themes" ]]; then
    echo "$(print_green "✓") Bat themes directory exists"
  else
    echo "$(print_yellow "⚠") Bat themes directory missing"
  fi
}

# ================================================================
# MAIN
# ================================================================

case "${1:-help}" in
  apply)
    apply_theme "${2:-}"
    ;;
  current)
    show_current
    ;;
  list)
    list_themes
    ;;
  favorites|favs)
    list_favorites
    ;;
  info)
    show_info "${2:-}"
    ;;
  random|rand)
    apply_random
    ;;
  reload)
    reload_apps
    ;;
  verify)
    verify_system
    ;;
  help|--help|-h)
    show_help
    ;;
  *)
    echo "$(print_red "Error:") Unknown command: $1"
    echo ""
    show_help
    exit 1
    ;;
esac
