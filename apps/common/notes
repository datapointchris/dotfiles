#!/usr/bin/env bash
# shellcheck disable=SC2016  # fzf preview commands use single quotes intentionally
# ================================================================
# notes - Quick note-taking with zk
# ================================================================
# Command-line interface for managing notes across sections
# ================================================================

set -euo pipefail

# Formatting functions are available in shell environment via .zshrc

NOTES_DIR="${ZK_NOTEBOOK_DIR:-$HOME/notes}"

show_help() {
  cat << EOF
$(print_cyan "notes - Quick note-taking with zk")

Command-line interface for managing notes across sections.

$(print_yellow "COMMANDS:")
  notes                  Show this help
  notes search           Search across all notes (full-text)
  notes new [section]    Create a new note (optionally specify section)
  notes recent           Browse recent notes
  notes browse           Browse notes by section

$(print_yellow "EXAMPLES:")
  notes search           # Full-text search, type to filter results
  notes new              # Pick a section, then create a note
  notes new dev          # Create a note directly in 'dev' section
  notes recent           # Browse last 50 notes
  notes browse           # Pick a section, browse its notes

$(print_yellow "DIRECT ZK ACCESS:")
  For full zk functionality, use 'zk' directly:
  - zk list              # List all notes
  - zk journal "..."     # Create journal entry
  - zk edit              # Edit notes

$(print_yellow "NOTEBOOK:")
  Location: $NOTES_DIR
  Config: ~/.config/zk/config.toml
EOF
}

# Check if zk is installed
if ! command -v zk &>/dev/null; then
  echo "$(print_yellow "Error:") zk is not installed"
  echo "Install with: brew install zk"
  exit 1
fi

# Check if notes directory exists
if [[ ! -d "$NOTES_DIR" ]]; then
  echo "$(print_yellow "Error:") Notes directory not found: $NOTES_DIR"
  echo "Run: zk init $NOTES_DIR"
  exit 1
fi

# Discover sections (top-level directories, excluding hidden)
discover_sections() {
  find -L "$NOTES_DIR" -mindepth 1 -maxdepth 1 -type d ! -name ".*" -exec basename {} \; | sort
}

# Search across all notes (full-text)
cmd_search() {
  if ! command -v rg &>/dev/null; then
    echo "$(print_yellow "Error:") ripgrep is required for full-text search"
    echo "Install with: brew install ripgrep"
    exit 1
  fi

  # Full-text search with live reload
  # Start with empty query, reload as user types
  local selected
  selected=$(
    FZF_DEFAULT_COMMAND="find -L '$NOTES_DIR' -type f -name '*.md' | sed 's|^$NOTES_DIR/||' | awk -F/ '{name=\$NF; sub(/\\.md$/,\"\",name); print name \"\\t\" \$0}'" \
    fzf --layout=reverse \
        --disabled \
        --bind "change:reload:rg --files-with-matches --no-messages --ignore-case {q} '$NOTES_DIR' | grep '\\.md\$' | sed 's|^$NOTES_DIR/||' | awk -F/ '{name=\$NF; sub(/\\.md$/,\"\",name); print name \"\\t\" \$0}' || true" \
        --bind "start:reload:rg --files-with-matches --no-messages --ignore-case '' '$NOTES_DIR' | grep '\\.md\$' | sed 's|^$NOTES_DIR/||' | awk -F/ '{name=\$NF; sub(/\\.md$/,\"\",name); print name \"\\t\" \$0}'" \
        --delimiter '\t' \
        --with-nth 1 \
        --preview 'rg --color=always --context=5 --ignore-case --pretty -- {q} ~/notes/{2} 2>/dev/null | fold -s -w $(tput cols) || bat -p --color always --wrap never ~/notes/{2} | fold -s -w $(tput cols)' \
        --preview-window=right:60% \
        --prompt 'Search: ' \
        --header 'Type to search note content | Enter to open'
  )

  if [[ -n "$selected" ]]; then
    local notepath=$(echo "$selected" | cut -f2)
    ${EDITOR:-nvim} ~/notes/"$notepath"
  fi
}

# Create new note (select section first)
cmd_new() {
  local section="$1"
  mapfile -t sections < <(discover_sections)

  if [[ ${#sections[@]} -eq 0 ]]; then
    echo "$(print_yellow "No sections found in:") $NOTES_DIR"
    echo "Create a directory like: mkdir $NOTES_DIR/journal"
    exit 1
  fi

  if ! command -v gum &>/dev/null; then
    echo "$(print_yellow "Error:") gum is required for interactive selection"
    echo "Install with: brew install gum"
    exit 1
  fi

  # If section provided as argument, validate it
  if [[ -n "$section" ]]; then
    # Check if section exists
    local found=0
    for s in "${sections[@]}"; do
      if [[ "$s" == "$section" ]]; then
        found=1
        break
      fi
    done

    if [[ $found -eq 0 ]]; then
      print_yellow "Section '$section' does not exist"
      # Fall through to interactive selection
      section=""
    fi
  fi

  # If no section or invalid section, prompt for selection
  if [[ -z "$section" ]]; then
    section=$(printf "%s\n" "${sections[@]}" | gum choose --height=25)

    if [[ -z "$section" ]]; then
      exit 0
    fi
  fi

  # Get note title
  local title
  title=$(gum input --placeholder "Note title")

  if [[ -z "$title" ]]; then
    exit 0
  fi

  # Try to use zk alias first (e.g., zk journal)
  if zk "$section" --help &>/dev/null; then
    zk "$section" "$title"
  else
    # Fallback: create in directory
    zk new "$NOTES_DIR/$section" --title "$title"
  fi
}

# Browse recent notes
cmd_recent() {
  local selected
  selected=$(zk list --quiet --format "{{filename-stem}}\t{{path}}" --sort modified- --limit 50 | \
    fzf --layout=reverse \
        --delimiter '\t' \
        --with-nth 1 \
        --preview "bat -p --color always --wrap never ~/notes/{2} | fold -s -w \$(tput cols)" \
        --preview-window=right:60%)

  if [[ -n "$selected" ]]; then
    local notepath=$(echo "$selected" | cut -f2)
    ${EDITOR:-nvim} ~/notes/"$notepath"
  fi
}

# Browse notes by section
cmd_browse() {
  mapfile -t sections < <(discover_sections)

  if [[ ${#sections[@]} -eq 0 ]]; then
    echo "$(print_yellow "No sections found in:") $NOTES_DIR"
    exit 1
  fi

  if ! command -v gum &>/dev/null; then
    echo "$(print_yellow "Error:") gum is required for interactive selection"
    echo "Install with: brew install gum"
    exit 1
  fi

  # Select section
  local section
  section=$(printf "%s\n" "${sections[@]}" | gum choose --height=25)

  if [[ -z "$section" ]]; then
    exit 0
  fi

  # Browse notes in selected section
  local selected
  selected=$(zk list --quiet --format "{{filename-stem}}\t{{path}}" "$section" | \
    fzf --layout=reverse \
        --delimiter '\t' \
        --with-nth 1 \
        --preview 'bat -p --color always --wrap never ~/notes/{2} | fold -s -w $(tput cols)' \
        --preview-window=right:60%)

  if [[ -n "$selected" ]]; then
    local notepath=$(echo "$selected" | cut -f2)
    ${EDITOR:-nvim} ~/notes/"$notepath"
  fi
}

# Main command routing
case "${1:-}" in
  search)
    cmd_search
    ;;

  new)
    cmd_new "${2:-}"
    ;;

  recent)
    cmd_recent
    ;;

  browse)
    cmd_browse
    ;;

  help|--help|-h|*)
    show_help
    ;;
esac
