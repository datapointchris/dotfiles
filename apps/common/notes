#!/usr/bin/env bash
# shellcheck disable=SC2016  # fzf preview commands use single quotes intentionally
# ================================================================
# notes - Quick note-taking with zk
# ================================================================
# Command-line interface for managing notes across sections
# ================================================================

set -euo pipefail

# Source formatting library
SHELL_DIR="${SHELL_DIR:-$HOME/.local/shell}"
source "$SHELL_DIR/formatting.sh"

NOTES_DIR="${ZK_NOTEBOOK_DIR:-$HOME/notes}"

show_help() {
  print_header "Notes - Quick Note-Taking with zk" "brightcyan"
  echo ""
  echo "Command-line interface for managing notes across sections."
  echo ""

  print_section "Commands" "brightmagenta"
  echo "  $(print_cyan "notes")                  Show this help"
  echo "  $(print_cyan "notes search")           Search across all notes (full-text)"
  echo "  $(print_cyan "notes new") [section]    Create a new note (optionally specify section)"
  echo "  $(print_cyan "notes recent")           Browse recent notes"
  echo "  $(print_cyan "notes browse")           Browse notes by section"
  echo ""

  print_section "Examples" "brightyellow"
  echo "  $(print_green "notes search")           # Full-text search, type to filter results"
  echo "  $(print_green "notes new")              # Pick a section, then create a note"
  echo "  $(print_green "notes new dev")          # Create a note directly in 'dev' section"
  echo "  $(print_green "notes recent")           # Browse last 50 notes"
  echo "  $(print_green "notes browse")           # Pick a section, browse its notes"
  echo ""

  print_section "Direct zk Access" "orange"
  echo "  For full zk functionality, use 'zk' directly:"
  echo "  • $(print_yellow "zk list")              # List all notes"
  echo "  • $(print_yellow "zk journal") \"...\"     # Create journal entry"
  echo "  • $(print_yellow "zk edit")              # Edit notes"
  echo ""

  print_section "Notebook" "brightblue"
  echo "  Location: $(print_cyan "$NOTES_DIR")"
  echo "  Config:   $(print_cyan "$HOME/.config/zk/config.toml")"
}

# Check if zk is installed
if ! command -v zk &>/dev/null; then
  print_error "zk is not installed"
  echo "Install with: brew install zk"
  exit 1
fi

# Check if notes directory exists
if [[ ! -d "$NOTES_DIR" ]]; then
  print_error "Notes directory not found: $NOTES_DIR"
  echo "Run: zk init $NOTES_DIR"
  exit 1
fi

# Discover sections (top-level directories, excluding hidden)
discover_sections() {
  find -L "$NOTES_DIR" -mindepth 1 -maxdepth 1 -type d ! -name ".*" -exec basename {} \; | sort
}

# Search across all notes (full-text)
cmd_search() {
  if ! command -v rg &>/dev/null; then
    print_error "ripgrep is required for full-text search"
    echo "Install with: brew install ripgrep"
    exit 1
  fi

  # Full-text search with live reload
  # Start with empty query, reload as user types
  local selected
  selected=$(
    FZF_DEFAULT_COMMAND="find -L '$NOTES_DIR' -type f -name '*.md' | sed 's|^$NOTES_DIR/||' | awk -F/ '{name=\$NF; sub(/\\.md$/,\"\",name); print name \"\\t\" \$0}'" \
    fzf --layout=reverse \
        --disabled \
        --bind "change:reload:rg --files-with-matches --no-messages --ignore-case {q} '$NOTES_DIR' | grep '\\.md\$' | sed 's|^$NOTES_DIR/||' | awk -F/ '{name=\$NF; sub(/\\.md$/,\"\",name); print name \"\\t\" \$0}' || true" \
        --bind "start:reload:rg --files-with-matches --no-messages --ignore-case '' '$NOTES_DIR' | grep '\\.md\$' | sed 's|^$NOTES_DIR/||' | awk -F/ '{name=\$NF; sub(/\\.md$/,\"\",name); print name \"\\t\" \$0}'" \
        --delimiter '\t' \
        --with-nth 1 \
        --preview 'rg --color=always --context=5 --ignore-case --pretty -- {q} ~/notes/{2} 2>/dev/null | fold -s -w $(tput cols) || bat -p --color always --wrap never ~/notes/{2} | fold -s -w $(tput cols)' \
        --preview-window=right:60% \
        --prompt 'Search: ' \
        --header 'Type to search note content | Enter to open'
  )

  if [[ -n "$selected" ]]; then
    local notepath=$(echo "$selected" | cut -f2)
    ${EDITOR:-nvim} ~/notes/"$notepath"
  fi
}

# Create new note (select section first)
cmd_new() {
  local section="$1"
  mapfile -t sections < <(discover_sections)

  if [[ ${#sections[@]} -eq 0 ]]; then
    print_warning "No sections found in: $NOTES_DIR"
    echo "Create a directory like: mkdir $NOTES_DIR/journal"
    exit 1
  fi

  if ! command -v gum &>/dev/null; then
    print_error "gum is required for interactive selection"
    echo "Install with: brew install gum"
    exit 1
  fi

  # If section provided as argument, validate it
  if [[ -n "$section" ]]; then
    # Check if section exists
    local found=0
    for s in "${sections[@]}"; do
      if [[ "$s" == "$section" ]]; then
        found=1
        break
      fi
    done

    if [[ $found -eq 0 ]]; then
      print_yellow "Section '$section' does not exist"
      # Fall through to interactive selection
      section=""
    fi
  fi

  # If no section or invalid section, prompt for selection
  if [[ -z "$section" ]]; then
    section=$(printf "%s\n" "${sections[@]}" | gum choose --height=25)

    if [[ -z "$section" ]]; then
      exit 0
    fi
  fi

  # Get note title
  local title
  title=$(gum input --placeholder "Note title")

  if [[ -z "$title" ]]; then
    exit 0
  fi

  # Try to use zk alias first (e.g., zk journal)
  if zk "$section" --help &>/dev/null; then
    zk "$section" "$title"
  else
    # Fallback: create in directory
    zk new "$NOTES_DIR/$section" --title "$title"
  fi
}

# Browse recent notes
cmd_recent() {
  local selected
  selected=$(zk list --quiet --format "{{filename-stem}}\t{{path}}" --sort modified- --limit 50 | \
    fzf --layout=reverse \
        --delimiter '\t' \
        --with-nth 1 \
        --preview "bat -p --color always --wrap never ~/notes/{2} | fold -s -w \$(tput cols)" \
        --preview-window=right:60%)

  if [[ -n "$selected" ]]; then
    local notepath=$(echo "$selected" | cut -f2)
    ${EDITOR:-nvim} ~/notes/"$notepath"
  fi
}

# Browse notes by section
cmd_browse() {
  mapfile -t sections < <(discover_sections)

  if [[ ${#sections[@]} -eq 0 ]]; then
    print_warning "No sections found in: $NOTES_DIR"
    exit 1
  fi

  if ! command -v gum &>/dev/null; then
    print_error "gum is required for interactive selection"
    echo "Install with: brew install gum"
    exit 1
  fi

  # Select section
  local section
  section=$(printf "%s\n" "${sections[@]}" | gum choose --height=25)

  if [[ -z "$section" ]]; then
    exit 0
  fi

  # Browse notes in selected section
  local selected
  selected=$(zk list --quiet --format "{{filename-stem}}\t{{path}}" "$section" | \
    fzf --layout=reverse \
        --delimiter '\t' \
        --with-nth 1 \
        --preview 'bat -p --color always --wrap never ~/notes/{2} | fold -s -w $(tput cols)' \
        --preview-window=right:60%)

  if [[ -n "$selected" ]]; then
    local notepath=$(echo "$selected" | cut -f2)
    ${EDITOR:-nvim} ~/notes/"$notepath"
  fi
}

# Main command routing
case "${1:-}" in
  search)
    cmd_search
    ;;

  new)
    cmd_new "${2:-}"
    ;;

  recent)
    cmd_recent
    ;;

  browse)
    cmd_browse
    ;;

  help|--help|-h|*)
    show_help
    ;;
esac
