#!/usr/bin/env bash
# Analyze commit workflow metrics and show savings

DOTFILES_DIR="${DOTFILES_DIR:-$HOME/dotfiles}"
METRICS_DIR="$DOTFILES_DIR/.claude/metrics"

echo "Commit Workflow Token Usage Analysis"
echo "====================================="
echo ""

# Check if metrics directory exists
if [[ ! -d "$METRICS_DIR" ]]; then
    echo "No metrics directory found at $METRICS_DIR"
    exit 0
fi

# Find all commit metrics files
found_files=0
for file in "$METRICS_DIR"/commit-metrics-*.jsonl; do
    if [[ -f "$file" ]]; then
        found_files=1
        echo "File: $(basename "$file")"
        echo ""

        # Count by method
        agent_count=$(grep -c '"method": "commit-agent"' "$file" 2>/dev/null || echo 0)
        direct_count=$(grep -c '"method": "direct-git"' "$file" 2>/dev/null || echo 0)

        echo "  Commit Agent: $agent_count commits"
        echo "  Direct Git:   $direct_count commits"
        echo ""

        # Calculate total savings
        total_savings=$(python3 -c "
import json
total = 0
with open('$file') as f:
    for line in f:
        try:
            entry = json.loads(line)
            total += entry.get('net_savings', 0)
        except:
            pass
print(f'{total:,} tokens')
")

        echo "  Net Token Savings: $total_savings"
        echo ""
    fi
done

if [[ $found_files -eq 0 ]]; then
    echo "No commit metrics found yet."
    echo ""
    echo "Metrics will be collected when you make commits."
    echo "The tracking hook logs to: $METRICS_DIR/commit-metrics-YYYY-MM-DD.jsonl"
fi
