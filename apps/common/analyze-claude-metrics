#!/usr/bin/env python3
"""
Analyze Claude Code workflow metrics.

Provides summary and detailed analysis of logsift commands and commit agent usage.
"""
import argparse
import json
import sys
from collections import defaultdict
from dataclasses import dataclass
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional


# ANSI color codes
class Colors:
    BLUE = '\033[0;34m'
    GREEN = '\033[0;32m'
    YELLOW = '\033[1;33m'
    RED = '\033[0;31m'
    NC = '\033[0m'  # No Color


@dataclass
class CommitAgentMetrics:
    """Metrics for commit agent workflow."""
    count: int = 0
    total_commits: int = 0
    total_files: int = 0
    total_tokens: int = 0
    phase_4_executed: int = 0
    phase_5_executed: int = 0
    read_instructions: int = 0


@dataclass
class LogsiftMetrics:
    """Metrics for logsift workflows."""
    count: int = 0
    successful: int = 0
    failed: int = 0
    total_errors: int = 0
    total_warnings: int = 0


class MetricsAnalyzer:
    """Analyze Claude Code workflow metrics from JSONL files."""

    def __init__(self, metrics_dir: Path):
        self.metrics_dir = metrics_dir
        self.entries: List[Dict] = []

    def load_metrics(self, date_filter: Optional[str] = None) -> None:
        """Load metrics from JSONL files."""
        if date_filter:
            files = [self.metrics_dir / f"command-metrics-{date_filter}.jsonl"]
        else:
            files = sorted(self.metrics_dir.glob("command-metrics-*.jsonl"))

        for file in files:
            if not file.exists():
                continue

            with open(file) as f:
                for line in f:
                    try:
                        entry = json.loads(line.strip())
                        self.entries.append(entry)
                    except json.JSONDecodeError:
                        continue

    def filter_by_type(self, metric_type: str) -> None:
        """Filter entries by metric type."""
        self.entries = [e for e in self.entries if e.get("type") == metric_type]

    def get_commit_agent_metrics(self) -> CommitAgentMetrics:
        """Calculate commit agent metrics."""
        metrics = CommitAgentMetrics()

        for entry in self.entries:
            if entry.get("type") != "commit-agent":
                continue

            metrics.count += 1
            metrics.total_commits += entry.get("commits_created", 0)
            metrics.total_files += entry.get("files_committed", 0)
            metrics.total_tokens += entry.get("tokens_used", 0)

            if entry.get("phase_4_executed"):
                metrics.phase_4_executed += 1
            if entry.get("phase_5_executed"):
                metrics.phase_5_executed += 1
            if entry.get("read_own_instructions"):
                metrics.read_instructions += 1

        return metrics

    def get_logsift_metrics(self) -> LogsiftMetrics:
        """Calculate logsift metrics."""
        metrics = LogsiftMetrics()

        for entry in self.entries:
            if entry.get("type") not in ["logsift", "logsift-auto"]:
                continue

            metrics.count += 1
            metrics.total_errors += entry.get("errors_found", 0)
            metrics.total_warnings += entry.get("warnings_found", 0)

            if entry.get("exit_code") == 0:
                metrics.successful += 1
            else:
                metrics.failed += 1

        return metrics

    def get_breakdown_by_type(self) -> Dict[str, int]:
        """Get count of entries by type."""
        breakdown = defaultdict(int)
        for entry in self.entries:
            breakdown[entry.get("type", "unknown")] += 1
        return dict(breakdown)

    def get_recent_commands(self, limit: int = 10) -> List[Dict]:
        """Get most recent commands."""
        return self.entries[-limit:]


def print_header(text: str) -> None:
    """Print a colored header."""
    print(f"{Colors.BLUE}{'━' * 45}{Colors.NC}")
    print(f"{Colors.BLUE}   {text}{Colors.NC}")
    print(f"{Colors.BLUE}{'━' * 45}{Colors.NC}")
    print()


def print_section_header(text: str) -> None:
    """Print a section header."""
    print(f"{Colors.BLUE}━━━ {text} ━━━{Colors.NC}")


def format_timestamp(iso_timestamp: str) -> str:
    """Format ISO timestamp to HH:MM:SS."""
    try:
        dt = datetime.fromisoformat(iso_timestamp)
        return dt.strftime("%H:%M:%S")
    except (ValueError, AttributeError):
        return "??:??:??"


def print_summary(analyzer: MetricsAnalyzer) -> None:
    """Print summary statistics."""
    print_header("Claude Code Workflow Metrics")

    total = len(analyzer.entries)
    print(f"{Colors.GREEN}Total Commands Tracked: {total}{Colors.NC}\n")

    # Breakdown by type
    breakdown = analyzer.get_breakdown_by_type()
    print("Breakdown by Type:")
    print(f"  Logsift:       {breakdown.get('logsift', 0)}")
    print(f"  Logsift Auto:  {breakdown.get('logsift-auto', 0)}")
    print(f"  Commit Agent:  {breakdown.get('commit-agent', 0)}")
    print()

    # Commit agent metrics
    commit_metrics = analyzer.get_commit_agent_metrics()
    if commit_metrics.count > 0:
        print_section_header("Commit Agent Metrics")
        print(f"  Total commits created: {commit_metrics.total_commits}")
        print(f"  Total files committed: {commit_metrics.total_files}")

        avg_tokens = commit_metrics.total_tokens // commit_metrics.count
        print(f"  Average tokens per run: {avg_tokens:,}")

        phase_4_pct = (100 * commit_metrics.phase_4_executed // commit_metrics.count
                       if commit_metrics.count > 0 else 0)
        print(f"  Phase 4 execution rate: {commit_metrics.phase_4_executed}/"
              f"{commit_metrics.count} ({phase_4_pct}%)")

        phase_5_pct = (100 * commit_metrics.phase_5_executed // commit_metrics.count
                       if commit_metrics.count > 0 else 0)
        print(f"  Phase 5 execution rate: {commit_metrics.phase_5_executed}/"
              f"{commit_metrics.count} ({phase_5_pct}%)")

        if commit_metrics.read_instructions > 0:
            print(f"{Colors.YELLOW}  ⚠️ Read own instructions: "
                  f"{commit_metrics.read_instructions} times (should be 0){Colors.NC}")
        print()

    # Logsift metrics
    logsift_metrics = analyzer.get_logsift_metrics()
    if logsift_metrics.count > 0:
        print_section_header("Logsift Metrics")
        print(f"  Total runs: {logsift_metrics.count}")
        print(f"  Successful: {logsift_metrics.successful}")
        print(f"  Failed: {logsift_metrics.failed}")
        print(f"  Total errors found: {logsift_metrics.total_errors}")
        print(f"  Total warnings found: {logsift_metrics.total_warnings}")
        print()

    print(f"{Colors.BLUE}{'━' * 45}{Colors.NC}")


def print_detailed(analyzer: MetricsAnalyzer) -> None:
    """Print detailed recent commands."""
    print_section_header("Recent Commands")

    for entry in analyzer.get_recent_commands():
        timestamp = format_timestamp(entry.get("timestamp", ""))
        cmd_type = entry.get("type", "unknown")

        if cmd_type == "commit-agent":
            commits = entry.get("commits_created", 0)
            files = entry.get("files_committed", 0)
            tokens = entry.get("tokens_used", 0)
            print(f"  [{timestamp}] commit-agent: {commits} commit(s), "
                  f"{files} files, {tokens:,} tokens")

        elif cmd_type in ["logsift", "logsift-auto"]:
            cmd = (entry.get("underlying_command") or
                   entry.get("interpreted_command", "unknown"))
            errors = entry.get("errors_found", 0)
            exit_code = entry.get("exit_code", "?")
            print(f"  [{timestamp}] {cmd_type}: '{cmd}' - "
                  f"exit {exit_code}, {errors} errors")

        else:
            print(f"  [{timestamp}] {cmd_type}")

    print()


def main():
    parser = argparse.ArgumentParser(
        description="Analyze Claude Code workflow metrics",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  %(prog)s                           # Summary of all metrics
  %(prog)s --type commit-agent       # Only commit agent metrics
  %(prog)s --date 2025-12-04         # Specific date
  %(prog)s --detailed                # Detailed breakdown
        """
    )

    parser.add_argument(
        "-t", "--type",
        choices=["logsift", "logsift-auto", "commit-agent"],
        help="Filter by metric type"
    )
    parser.add_argument(
        "-d", "--date",
        metavar="YYYY-MM-DD",
        help="Show metrics for specific date"
    )
    parser.add_argument(
        "--detailed",
        action="store_true",
        help="Show detailed breakdown with recent commands"
    )
    parser.add_argument(
        "--summary",
        action="store_true",
        default=True,
        help="Show summary only (default)"
    )

    args = parser.parse_args()

    # Determine metrics directory
    dotfiles_dir = Path.home() / "dotfiles"
    metrics_dir = dotfiles_dir / ".claude/metrics"

    if not metrics_dir.exists():
        print(f"No metrics directory found at {metrics_dir}")
        print("\nMetrics will be collected when you use:")
        print("  - /logsift or /logsift-auto commands")
        print("  - Commit agent")
        sys.exit(0)

    # Load and analyze metrics
    analyzer = MetricsAnalyzer(metrics_dir)
    analyzer.load_metrics(args.date)

    if not analyzer.entries:
        print("No metrics found")
        print("\nMetrics will be collected when you use:")
        print("  - /logsift or /logsift-auto commands")
        print("  - Commit agent")
        sys.exit(0)

    # Apply filters
    if args.type:
        analyzer.filter_by_type(args.type)

    # Print output
    print_summary(analyzer)

    if args.detailed:
        print_detailed(analyzer)


if __name__ == "__main__":
    main()
