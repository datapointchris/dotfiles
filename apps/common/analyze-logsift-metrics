#!/usr/bin/env bash
# Analyze logsift command metrics for token usage and quality
set -euo pipefail

METRICS_DIR="${HOME}/dotfiles/.claude/metrics"
LOGSIFT_LOGS="${HOME}/.local/share/logsift/logs"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_header() {
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

# Parse command line arguments
SHOW_DETAILS=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -d|--details) SHOW_DETAILS=true; shift ;;
        --date) shift 2 ;;  # Reserved for future use
        *) echo "Unknown option: $1"; exit 1 ;;
    esac
done

# Check if metrics directory exists
if [[ ! -d "$METRICS_DIR" ]]; then
    echo -e "${YELLOW}No metrics directory found at $METRICS_DIR${NC}"
    echo "Run /logsift commands to start collecting metrics"
    exit 0
fi

print_header "Logsift Command Metrics Analysis"

# Count total commands by type
total_logsift=$(find "$METRICS_DIR" -name "*.jsonl" -exec grep -h '"command": "/logsift"' {} \; | wc -l)
total_logsift_auto=$(find "$METRICS_DIR" -name "*.jsonl" -exec grep -h '"command": "/logsift-auto"' {} \; | wc -l)

echo ""
echo -e "${GREEN}Command Usage:${NC}"
echo "  /logsift:      $total_logsift invocations"
echo "  /logsift-auto: $total_logsift_auto invocations"
echo ""

# Show recent commands
print_header "Recent Commands (Last 10)"
echo ""

find "$METRICS_DIR" -name "*.jsonl" -exec cat {} \; | \
    tail -10 | \
    jq -r '"\(.timestamp | split("T")[0]) \(.timestamp | split("T")[1] | split(".")[0]) | \(.command) | \(.full_command | split("\n")[0] | .[0:80])"' | \
    while IFS='|' read -r timestamp cmd full; do
        echo -e "${BLUE}$timestamp${NC} ${GREEN}$cmd${NC}"
        echo "  $full"
        echo ""
    done

# Quality analysis from logsift logs
if [[ -d "$LOGSIFT_LOGS" ]]; then
    print_header "Error Resolution Analysis"
    echo ""

    # Find recent logsift sessions
    recent_sessions=$(find "$LOGSIFT_LOGS" -name "*.json" -mtime -7 | head -10)

    if [[ -n "$recent_sessions" ]]; then
        total_errors=0
        total_warnings=0
        total_runs=0

        while IFS= read -r session; do
            ((total_runs++)) || true
            errors=$(jq -r '.analysis.error_count // 0' "$session" 2>/dev/null || echo 0)
            warnings=$(jq -r '.analysis.warning_count // 0' "$session" 2>/dev/null || echo 0)
            total_errors=$((total_errors + errors))
            total_warnings=$((total_warnings + warnings))

            if [[ "$SHOW_DETAILS" == "true" ]]; then
                command=$(jq -r '.command' "$session" 2>/dev/null || echo "unknown")
                duration=$(jq -r '.duration' "$session" 2>/dev/null || echo "unknown")
                echo -e "  Session: $(basename "$session")"
                echo -e "    Command: ${BLUE}$command${NC}"
                echo -e "    Duration: $duration"
                echo -e "    Errors: ${RED}$errors${NC} | Warnings: ${YELLOW}$warnings${NC}"
                echo ""
            fi
        done <<< "$recent_sessions"

        avg_errors=$(echo "scale=2; $total_errors / $total_runs" | bc)
        avg_warnings=$(echo "scale=2; $total_warnings / $total_runs" | bc)

        echo -e "${GREEN}Last 7 Days Summary:${NC}"
        echo "  Total runs: $total_runs"
        echo -e "  Avg errors per run: ${RED}$avg_errors${NC}"
        echo -e "  Avg warnings per run: ${YELLOW}$avg_warnings${NC}"
        echo ""
    else
        echo "No recent logsift sessions found"
        echo ""
    fi
fi

# Cost estimation (rough)
print_header "Estimated Token Usage"
echo ""
echo -e "${YELLOW}Note: Use /cost command during sessions for accurate usage${NC}"
echo ""

# Suggest next steps
print_header "Recommendations"
echo ""
echo "1. Compare /logsift vs /logsift-auto effectiveness:"
echo "   - Track which resolves errors faster"
echo "   - Note any parsing issues with /logsift-auto"
echo ""
echo "2. Enable OpenTelemetry for detailed token tracking:"
echo "   export CLAUDE_CODE_ENABLE_TELEMETRY=1"
echo ""
echo "3. Use /cost command during sessions to see real-time usage"
echo ""
echo "4. Run with --details flag to see per-session breakdown:"
echo "   analyze-logsift-metrics --details"
echo ""
