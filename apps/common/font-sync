#!/usr/bin/env bash
# Font management for systematic testing and application
# Similar workflow to theme-sync but for fonts

set -euo pipefail

# Font directories
CODE_FONTS_DIR="$HOME/Documents/code_fonts"

# XDG-compliant data directory
XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
FONT_DATA_DIR="$XDG_DATA_HOME/font-sync"
FONT_LOG="$FONT_DATA_DIR/font-testing-log.md"

# Config file locations
GHOSTTY_CONFIG="$HOME/.config/ghostty/config"
NVIM_FONT_CONFIG="$HOME/.config/nvim/lua/config/font.lua"

# Favorites list (start with what you know you like)
FAVORITES=(
  "SeriousShanns Nerd Font Propo"
  "FiraCode Nerd Font"
  "JetBrains Mono Nerd Font"
)

usage() {
  cat <<EOF
Font testing and management workflow

Usage: font-sync <command> [args]

Commands:
  list                List all available code fonts
  favorites           Show favorite fonts
  current             Show currently active font
  apply <font>        Apply font to Ghostty/Neovim/VS Code
  test <font>         Start testing a font (logs start date)
  like <font>         Mark current/specified font as liked
  dislike <font>      Mark current/specified font as disliked
  notes <font> <msg>  Add notes about a font
  log                 View testing log
  preview             Interactive font picker with fzf
  random              Apply random font from favorites
  adventure           Apply random font from ALL available fonts (adventure mode!)
  install <font>      Install font from code_fonts to system

Examples:
  font-sync preview              # Interactive selection
  font-sync apply "FiraCode Nerd Font"
  font-sync test "JetBrains Mono Nerd Font"
  font-sync like                 # Like current font
  font-sync notes "FiraCode Nerd Font" "Great for Python, ligatures a bit much"
  font-sync random               # Random from favorites - safe choice
  font-sync adventure            # Random from all fonts - adventure mode!
EOF
}

# Initialize font log if it doesn't exist
init_log() {
  # Create XDG data directory if needed
  mkdir -p "$FONT_DATA_DIR"

  if [[ ! -f "$FONT_LOG" ]]; then
    cat > "$FONT_LOG" <<'LOGEOF'
# Font Testing Log

Track which fonts you've tested, liked, and want to keep.

## Currently Testing

None

## Liked (Keepers)

- SeriousShanns Nerd Font Propo - Comic sans style, fun and readable

## Disliked (Can Remove)

## Testing History

LOGEOF
  fi
}

# List all available code fonts
list_fonts() {
  if [[ ! -d "$CODE_FONTS_DIR" ]]; then
    echo "Error: $CODE_FONTS_DIR not found"
    exit 1
  fi

  # Extract unique font family names from installed fonts
  fc-list : family | grep -i "nerd\|fira\|code\|mono\|shanns\|iosevka" | sort -u
}

# Show favorites
show_favorites() {
  printf '%s\n' "${FAVORITES[@]}"
}

# Get current font from Ghostty config
get_current_font() {
  if [[ -f "$GHOSTTY_CONFIG" ]]; then
    grep "^font-family" "$GHOSTTY_CONFIG" | cut -d= -f2 | xargs
  else
    echo "Unknown"
  fi
}

# Apply font to all configs
apply_font() {
  local font="$1"

  echo "Applying font: $font"

  # Update Ghostty
  if [[ -f "$GHOSTTY_CONFIG" ]]; then
    # Use a safer sed approach - backup first
    cp "$GHOSTTY_CONFIG" "$GHOSTTY_CONFIG.bak"
    sed -i '' "s/^font-family = .*/font-family = \"$font\"/" "$GHOSTTY_CONFIG"
    echo "âœ“ Updated Ghostty config"
  fi

  # Update Neovim if config exists
  if [[ -f "$NVIM_FONT_CONFIG" ]]; then
    cp "$NVIM_FONT_CONFIG" "$NVIM_FONT_CONFIG.bak"
    sed -i '' "s/vim.o.guifont = .*/vim.o.guifont = \"$font:h15\"/" "$NVIM_FONT_CONFIG"
    echo "âœ“ Updated Neovim config"
  fi

  # VS Code settings (if it exists)
  local vscode_settings="$HOME/Library/Application Support/Code/User/settings.json"
  if [[ -f "$vscode_settings" ]]; then
    echo "  Note: Update VS Code manually to 'editor.fontFamily': \"$font\""
  fi

  echo ""
  echo "Font applied! Restart Ghostty to see changes."
  echo "Run: font-sync test \"$font\" to start tracking this test"
}

# Start testing a font
start_test() {
  local font="${1:-$(get_current_font)}"
  local date=$(date +%Y-%m-%d)

  init_log

  # Update "Currently Testing" section
  sed -i '' "/^## Currently Testing/,/^## / s/None/${font} (started ${date})/" "$FONT_LOG"

  # Add to testing history
  echo "- **${font}** - Started ${date}" >> "$FONT_LOG"

  echo "Started testing: $font"
  echo "Check back in a week to decide if you like it!"
}

# Mark font as liked
mark_liked() {
  local font="${1:-$(get_current_font)}"
  local date=$(date +%Y-%m-%d)

  init_log

  # Add to Liked section (after the header line)
  sed -i '' "/^## Liked (Keepers)/a\\
- ${font} - Added ${date}
" "$FONT_LOG"

  # Clear from Currently Testing
  sed -i '' "/^## Currently Testing/,/^## / s/${font}.*$/None/" "$FONT_LOG"

  echo "âœ“ Added $font to liked fonts"
}

# Mark font as disliked
mark_disliked() {
  local font="${1:-$(get_current_font)}"
  local date=$(date +%Y-%m-%d)

  init_log

  # Add to Disliked section
  sed -i '' "/^## Disliked (Can Remove)/a\\
- ${font} - Added ${date}
" "$FONT_LOG"

  # Clear from Currently Testing
  sed -i '' "/^## Currently Testing/,/^## / s/${font}.*$/None/" "$FONT_LOG"

  echo "âœ“ Added $font to disliked fonts"
  echo "  You can remove this from ~/Documents/code_fonts later"
}

# Add notes about a font
add_notes() {
  local font="$1"
  shift
  local note="$*"
  local date=$(date +%Y-%m-%d)

  init_log

  echo "  - [$date] $note" >> "$FONT_LOG"

  echo "âœ“ Added note for $font"
}

# Show the log
show_log() {
  init_log

  if command -v bat &>/dev/null; then
    bat "$FONT_LOG"
  else
    cat "$FONT_LOG"
  fi
}

# Interactive font preview with fzf
preview_fonts() {
  if ! command -v fzf &>/dev/null; then
    echo "Error: fzf not found. Install with: brew install fzf"
    exit 1
  fi

  local selected
  selected=$(list_fonts | fzf \
    --prompt="Select font > " \
    --height=50% \
    --preview="echo 'Font: {}'; echo ''; echo 'Preview:'; echo 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'; echo 'abcdefghijklmnopqrstuvwxyz'; echo '0123456789 !@#\$%^&*()'; echo 'The quick brown fox jumps over the lazy dog'" \
    --preview-window=right:50%)

  if [[ -n "$selected" ]]; then
    apply_font "$selected"
  fi
}

# Apply random favorite
random_favorite() {
  local random_font="${FAVORITES[$RANDOM % ${#FAVORITES[@]}]}"
  echo "ðŸŽ² Randomly selected from favorites: $random_font"
  echo ""
  apply_font "$random_font"
}

# Apply random from ALL available fonts - ADVENTURE MODE!
adventure_mode() {
  # Get all available fonts into an array
  mapfile -t all_fonts < <(list_fonts)

  if [[ ${#all_fonts[@]} -eq 0 ]]; then
    echo "Error: No fonts found"
    exit 1
  fi

  # Pick a random one
  local random_font="${all_fonts[$RANDOM % ${#all_fonts[@]}]}"

  echo "ðŸŽ² ADVENTURE MODE: Randomly selected from ALL fonts"
  echo "Font: $random_font"
  echo ""
  echo "No choice paralysis - just use it and see how you feel!"
  echo ""
  apply_font "$random_font"

  # Automatically start tracking this test
  echo ""
  start_test "$random_font"
}

# Install font from code_fonts to system
install_font() {
  local font_file="$1"

  if [[ ! -f "$CODE_FONTS_DIR/$font_file" ]]; then
    echo "Error: Font file not found in $CODE_FONTS_DIR"
    exit 1
  fi

  cp "$CODE_FONTS_DIR/$font_file" "$HOME/Library/Fonts/"
  echo "âœ“ Installed $font_file"
  echo "  Run: fc-cache -f to refresh font cache"
}

# Main command dispatcher
main() {
  case "${1:-}" in
    list)
      list_fonts
      ;;
    favorites)
      show_favorites
      ;;
    current)
      echo "Current font: $(get_current_font)"
      ;;
    apply)
      if [[ -z "${2:-}" ]]; then
        echo "Error: Font name required"
        usage
        exit 1
      fi
      apply_font "$2"
      ;;
    test)
      start_test "${2:-}"
      ;;
    like)
      mark_liked "${2:-}"
      ;;
    dislike)
      mark_disliked "${2:-}"
      ;;
    notes)
      if [[ -z "${2:-}" ]]; then
        echo "Error: Font name and notes required"
        usage
        exit 1
      fi
      add_notes "$2" "${@:3}"
      ;;
    log)
      show_log
      ;;
    preview)
      preview_fonts
      ;;
    random)
      random_favorite
      ;;
    adventure)
      adventure_mode
      ;;
    install)
      if [[ -z "${2:-}" ]]; then
        echo "Error: Font file required"
        usage
        exit 1
      fi
      install_font "$2"
      ;;
    *)
      usage
      exit 1
      ;;
  esac
}

init_log
main "$@"
