#!/usr/bin/env bash
# One-time font cleanup and standardization
# Moves unused variants to review folder and standardizes naming

set -euo pipefail

CODE_FONTS_DIR="$HOME/Documents/code_fonts"
REVIEW_DIR="$HOME/Documents/code_fonts_review"

# Variants to remove (not useful for coding)
REMOVE_VARIANTS=(
  "Light"
  "LightItalic"
  "Medium"
  "MediumItalic"
  "SemiBold"
  "SemiBoldItalic"
  "ExtraLight"
  "ExtraLightItalic"
  "Black"
  "BlackItalic"
  "Retina"
  "Thin"
  "ThinItalic"
  "ExtraBold"
  "ExtraBoldItalic"
)

# Check if variant should be removed
should_remove() {
  local filename="$1"

  for variant in "${REMOVE_VARIANTS[@]}"; do
    if [[ "$filename" =~ -${variant}\. ]] || [[ "$filename" =~ ${variant}\. ]]; then
      return 0
    fi
  done

  return 1
}

# Standardize font name to ImageMagick style
standardize_name() {
  local filename="$1"
  local ext="${filename##*.}"
  local base="${filename%.*}"

  # Remove "for Powerline" suffix
  base="${base% for Powerline}"

  # Fix smooshed NerdFont variants (must be before space handling)
  base=$(echo "$base" | sed 's/NerdFontPropo/-Nerd-Font-Propo/g')
  base=$(echo "$base" | sed 's/NerdFontMono/-Nerd-Font-Mono/g')
  base=$(echo "$base" | sed 's/NerdFont/-Nerd-Font/g')

  # Replace spaces with hyphens
  base="${base// /-}"

  # Handle numeric weights (CommitMono style: 400=Regular, 700=Bold)
  if [[ "$base" =~ -400- ]]; then
    base=$(echo "$base" | sed 's/-400-/-/')
  elif [[ "$base" =~ -700- ]]; then
    if [[ "$base" =~ -700-Regular$ ]]; then
      base=$(echo "$base" | sed 's/-700-Regular$/-Bold/')
    elif [[ "$base" =~ -700-Italic$ ]]; then
      base=$(echo "$base" | sed 's/-700-Italic$/-BoldItalic/')
    fi
  fi

  # Capitalize first letter if all lowercase
  if [[ "$base" =~ ^[a-z] ]]; then
    base="$(tr '[:lower:]' '[:upper:]' <<< "${base:0:1}")${base:1}"
  fi

  # Add -Regular suffix if no variant specified
  # (file ends with family name, no hyphen before extension)
  if [[ ! "$base" =~ -(Regular|Bold|Italic|BoldItalic)$ ]]; then
    # Check if it's just a family name with no variant
    if [[ "$base" =~ ^[A-Z][a-zA-Z0-9-]*$ ]] && [[ ! "$base" =~ -[0-9]$ ]]; then
      base="${base}-Regular"
    fi
  fi

  echo "${base}.${ext}"
}

# Main cleanup function
main() {
  local action="${1:-dry-run}"

  if [[ ! -d "$CODE_FONTS_DIR" ]]; then
    echo "Error: $CODE_FONTS_DIR not found"
    exit 1
  fi

  cd "$CODE_FONTS_DIR"

  echo "Font Cleanup and Standardization"
  echo "=================================="
  echo ""

  # Count files
  local total_fonts=$(find . -maxdepth 1 -type f \( -name "*.ttf" -o -name "*.otf" \) | wc -l | tr -d ' ')
  echo "Total fonts: $total_fonts"
  echo ""

  # Analyze what will be removed
  echo "Step 1: Analyzing variants to remove..."
  echo ""

  local to_remove=()
  while IFS= read -r -d '' file; do
    local filename=$(basename "$file")
    if should_remove "$filename"; then
      to_remove+=("$filename")
    fi
  done < <(find . -maxdepth 1 -type f \( -name "*.ttf" -o -name "*.otf" \) -print0)

  if [[ ${#to_remove[@]} -gt 0 ]]; then
    echo "Will move ${#to_remove[@]} files to review folder:"
    printf '  - %s\n' "${to_remove[@]}" | sort
    echo ""
  else
    echo "No variants to remove."
    echo ""
  fi

  # Analyze what will be renamed
  echo "Step 2: Analyzing fonts to standardize..."
  echo ""

  local to_rename=()
  while IFS= read -r -d '' file; do
    local filename=$(basename "$file")

    # Skip files that will be removed
    if should_remove "$filename"; then
      continue
    fi

    local new_name=$(standardize_name "$filename")

    if [[ "$filename" != "$new_name" ]]; then
      to_rename+=("$filename|$new_name")
    fi
  done < <(find . -maxdepth 1 -type f \( -name "*.ttf" -o -name "*.otf" \) -print0)

  if [[ ${#to_rename[@]} -gt 0 ]]; then
    echo "Will rename ${#to_rename[@]} files:"
    for entry in "${to_rename[@]}"; do
      local old="${entry%|*}"
      local new="${entry#*|}"
      echo "  $old"
      echo "    -> $new"
    done
    echo ""
  else
    echo "All remaining fonts already have standard names."
    echo ""
  fi

  local remaining=$((total_fonts - ${#to_remove[@]}))
  echo "Summary:"
  echo "  Current fonts: $total_fonts"
  echo "  Will remove: ${#to_remove[@]}"
  echo "  Will rename: ${#to_rename[@]}"
  echo "  Remaining: $remaining"
  echo ""

  # Execute if requested
  if [[ "$action" == "execute" ]]; then
    echo "Executing cleanup..."
    echo ""

    # Create review directory
    mkdir -p "$REVIEW_DIR"

    # Move files to review
    if [[ ${#to_remove[@]} -gt 0 ]]; then
      echo "Moving ${#to_remove[@]} files to review folder..."
      for filename in "${to_remove[@]}"; do
        mv -v "$filename" "$REVIEW_DIR/"
      done
      echo ""
    fi

    # Rename files
    if [[ ${#to_rename[@]} -gt 0 ]]; then
      echo "Renaming ${#to_rename[@]} files..."
      for entry in "${to_rename[@]}"; do
        local old="${entry%|*}"
        local new="${entry#*|}"

        # Check if destination already exists
        if [[ -f "$new" ]]; then
          echo "Warning: $new already exists, skipping rename of $old"
        else
          mv -v "$old" "$new"
        fi
      done
      echo ""
    fi

    echo "âœ“ Cleanup complete!"
    echo ""
    echo "Review folder: $REVIEW_DIR"
    echo "Remaining fonts: $remaining"
    echo ""
    echo "Next steps:"
    echo "  1. Review files in $REVIEW_DIR"
    echo "  2. Delete review folder when satisfied: rm -rf $REVIEW_DIR"
    echo "  3. Run: fc-cache -f to refresh font cache"

  else
    echo "This was a dry-run. No changes made."
    echo ""
    echo "To execute the cleanup, run:"
    echo "  font-cleanup execute"
  fi
}

main "$@"
