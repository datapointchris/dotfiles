#!/usr/bin/env bash
# Comprehensive test suite for font application
# Tests every function in isolation before integrating with fzf

set -euo pipefail

# Source the library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FONT_APP_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
source "$FONT_APP_DIR/lib/lib.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Test counters
TESTS_RUN=0
TESTS_PASSED=0
TESTS_FAILED=0

# Test result tracking
declare -a FAILED_TESTS=()

# ==============================================================================
# TEST HELPERS
# ==============================================================================

test_start() {
  echo ""
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo "TEST: $1"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  TESTS_RUN=$((TESTS_RUN + 1))
}

test_pass() {
  echo -e "${GREEN}✓ PASS${NC}: $1"
  TESTS_PASSED=$((TESTS_PASSED + 1))
}

test_fail() {
  echo -e "${RED}✗ FAIL${NC}: $1"
  TESTS_FAILED=$((TESTS_FAILED + 1))
  FAILED_TESTS+=("$1")
}

test_info() {
  echo -e "${YELLOW}ℹ INFO${NC}: $1"
}

# ==============================================================================
# TEST SUITE
# ==============================================================================

test_preview_text_file() {
  test_start "Preview text file exists and is readable"

  if [[ -f "$PREVIEW_TEXT_FILE" ]]; then
    test_pass "Preview text file exists: $PREVIEW_TEXT_FILE"
  else
    test_fail "Preview text file not found: $PREVIEW_TEXT_FILE"
    return 1
  fi

  if [[ -r "$PREVIEW_TEXT_FILE" ]]; then
    test_pass "Preview text file is readable"
  else
    test_fail "Preview text file is not readable"
    return 1
  fi

  local line_count=$(wc -l < "$PREVIEW_TEXT_FILE")
  test_info "Preview text has $line_count lines"

  if [[ $line_count -gt 10 ]]; then
    test_pass "Preview text has sufficient content"
  else
    test_fail "Preview text is too short"
    return 1
  fi
}

test_list_fonts() {
  test_start "List fonts function"

  local font_count
  font_count=$(count_fonts)

  test_info "Found $font_count fonts"

  if [[ $font_count -gt 0 ]]; then
    test_pass "list_fonts returns fonts"
  else
    test_fail "list_fonts returned no fonts"
    return 1
  fi

  # Show first few fonts
  test_info "Sample fonts:"
  list_fonts | head -5 | while read -r font; do
    test_info "  - $font"
  done
}

test_get_font_file_path() {
  test_start "Get font file path for each font"

  local fonts_checked=0
  local fonts_found=0
  local fonts_missing=0

  while IFS= read -r font; do
    fonts_checked=$((fonts_checked + 1))

    if font_file=$(get_font_file_path "$font"); then
      fonts_found=$((fonts_found + 1))
      test_pass "Font file found: $font -> $font_file"
    else
      fonts_missing=$((fonts_missing + 1))
      test_fail "Font file NOT found: $font"
    fi
  done < <(list_fonts)

  test_info "Summary: $fonts_checked fonts checked, $fonts_found found, $fonts_missing missing"

  if [[ $fonts_missing -eq 0 ]]; then
    test_pass "All fonts have accessible file paths"
  else
    test_fail "$fonts_missing fonts could not be located"
    return 1
  fi
}

test_generate_previews_all() {
  test_start "Generate preview for EVERY font"

  # Clear cache first
  clear_preview_cache >/dev/null

  local fonts_total=0
  local fonts_success=0
  local fonts_failed=0
  declare -a failed_fonts=()

  while IFS= read -r font; do
    fonts_total=$((fonts_total + 1))

    test_info "Generating preview for: $font"

    local cache_file
    cache_file=$(get_cached_preview_path "$font")

    if generate_font_preview "$font" "$cache_file" 2>/dev/null; then
      fonts_success=$((fonts_success + 1))
      test_pass "Preview generated: $font"
    else
      fonts_failed=$((fonts_failed + 1))
      failed_fonts+=("$font")
      test_fail "Preview generation failed: $font"
    fi
  done < <(list_fonts)

  test_info "Summary: $fonts_total total, $fonts_success success, $fonts_failed failed"

  if [[ $fonts_failed -gt 0 ]]; then
    test_fail "Failed fonts:"
    for font in "${failed_fonts[@]}"; do
      test_fail "  - $font"
    done
    return 1
  else
    test_pass "All $fonts_total fonts generated successfully"
  fi
}

test_validate_all_previews() {
  test_start "Validate ALL generated preview images"

  local images_total=0
  local images_valid=0
  local images_invalid=0

  while IFS= read -r font; do
    images_total=$((images_total + 1))

    local cache_file
    cache_file=$(get_cached_preview_path "$font")

    if validate_preview_image "$cache_file" >/dev/null 2>&1; then
      images_valid=$((images_valid + 1))
      local file_info
      file_info=$(validate_preview_image "$cache_file")
      test_pass "Valid image: $font"
      test_info "  $file_info"
    else
      images_invalid=$((images_invalid + 1))
      test_fail "Invalid image: $font"
    fi
  done < <(list_fonts)

  test_info "Summary: $images_total checked, $images_valid valid, $images_invalid invalid"

  if [[ $images_invalid -eq 0 ]]; then
    test_pass "All preview images are valid PNGs"
  else
    test_fail "$images_invalid images are invalid"
    return 1
  fi
}

test_cache_functionality() {
  test_start "Cache functionality"

  local test_font
  test_font=$(list_fonts | head -1)

  if [[ -z "$test_font" ]]; then
    test_fail "No fonts available for testing"
    return 1
  fi

  test_info "Testing with font: $test_font"

  # Clear cache
  clear_preview_cache >/dev/null

  # First call should generate
  local preview_file
  if preview_file=$(get_or_generate_preview "$test_font"); then
    test_pass "First call generated preview: $preview_file"
  else
    test_fail "Failed to generate preview"
    return 1
  fi

  # Get modification time
  local mtime1
  mtime1=$(stat -f %m "$preview_file" 2>/dev/null || stat -c %Y "$preview_file" 2>/dev/null)

  # Wait a second
  sleep 1

  # Second call should use cache
  local preview_file2
  if preview_file2=$(get_or_generate_preview "$test_font"); then
    test_pass "Second call returned preview"
  else
    test_fail "Failed to get cached preview"
    return 1
  fi

  # Check modification time didn't change
  local mtime2
  mtime2=$(stat -f %m "$preview_file2" 2>/dev/null || stat -c %Y "$preview_file2" 2>/dev/null)

  if [[ "$mtime1" == "$mtime2" ]]; then
    test_pass "Cache was used (file not regenerated)"
  else
    test_fail "Cache was not used (file was regenerated)"
    return 1
  fi
}

test_display_preview() {
  test_start "Display preview functionality"

  local test_font
  test_font=$(list_fonts | head -1)

  if [[ -z "$test_font" ]]; then
    test_fail "No fonts available for testing"
    return 1
  fi

  local preview_file
  preview_file=$(get_cached_preview_path "$test_font")

  if [[ ! -f "$preview_file" ]]; then
    test_fail "Preview file does not exist: $preview_file"
    return 1
  fi

  if command -v chafa &>/dev/null || command -v viu &>/dev/null; then
    test_pass "Display tool available"
    test_info "Testing display (output suppressed)..."
    if display_preview_image "$preview_file" >/dev/null 2>&1; then
      test_pass "Display command succeeded"
    else
      test_fail "Display command failed"
      return 1
    fi
  else
    test_fail "No display tool available (install chafa or viu)"
    return 1
  fi
}

# ==============================================================================
# MAIN TEST RUNNER
# ==============================================================================

main() {
  echo "╔════════════════════════════════════════════════════════════════════════╗"
  echo "║                    FONT-SYNC TEST SUITE                                ║"
  echo "╚════════════════════════════════════════════════════════════════════════╝"

  test_info "Starting comprehensive test suite..."
  test_info "Preview text file: $PREVIEW_TEXT_FILE"
  test_info "Cache directory: $PREVIEW_CACHE_DIR"

  # Run all tests
  test_preview_text_file
  test_list_fonts
  test_get_font_file_path
  test_generate_previews_all
  test_validate_all_previews
  test_cache_functionality
  test_display_preview

  # Summary
  echo ""
  echo "╔════════════════════════════════════════════════════════════════════════╗"
  echo "║                         TEST SUMMARY                                   ║"
  echo "╚════════════════════════════════════════════════════════════════════════╝"
  echo ""
  echo "Total tests run:    $TESTS_RUN"
  echo -e "${GREEN}Tests passed:       $TESTS_PASSED${NC}"

  if [[ $TESTS_FAILED -gt 0 ]]; then
    echo -e "${RED}Tests failed:       $TESTS_FAILED${NC}"
    echo ""
    echo "Failed tests:"
    for test in "${FAILED_TESTS[@]}"; do
      echo -e "  ${RED}✗${NC} $test"
    done
    echo ""
    exit 1
  else
    echo -e "${GREEN}All tests passed!${NC}"
    echo ""
    exit 0
  fi
}

main "$@"
