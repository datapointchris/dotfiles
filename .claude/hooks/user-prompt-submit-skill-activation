#!/usr/bin/env python
"""
Analyzes user prompts and file context to suggest relevant skills.
Based on showcase repo's skill activation pattern.
"""
import json
import re
import subprocess
import sys
from pathlib import Path


def get_repo_root():
    """Get git repository root directory"""
    result = subprocess.run(
        ["git", "rev-parse", "--show-toplevel"],
        capture_output=True,
        text=True
    )
    return Path(result.stdout.strip())


def load_skill_rules():
    """Load skill-rules.json"""
    repo_root = get_repo_root()
    rules_path = repo_root / ".claude/skill-rules.json"
    if not rules_path.exists():
        return {}

    with open(rules_path) as f:
        return json.load(f)


def check_prompt_triggers(prompt, skill_config):
    """Check if prompt matches skill keywords or patterns"""
    prompt_lower = prompt.lower()

    # Check keywords
    keywords = skill_config.get("promptTriggers", {}).get("keywords", [])
    if any(kw in prompt_lower for kw in keywords):
        return True

    # Check intent patterns
    patterns = skill_config.get("promptTriggers", {}).get("intentPatterns", [])
    for pattern in patterns:
        if re.search(pattern, prompt_lower):
            return True

    return False


def check_file_triggers(files, skill_config):
    """Check if any files match skill path patterns"""
    path_patterns = skill_config.get("fileTriggers", {}).get("pathPatterns", [])

    for file_path in files:
        for pattern in path_patterns:
            # Simple glob-like matching
            pattern_regex = pattern.replace("**", ".*").replace("*", "[^/]*")
            if re.search(pattern_regex, file_path):
                return True

    return False


def main():
    try:
        # Log initial state for debugging
        import os
        import traceback
        cwd = os.getcwd()
        print(f"üîç [user-prompt-submit] Starting from: {cwd}", file=sys.stderr)

        hook_input = json.loads(sys.stdin.read())
        prompt = hook_input.get("prompt", "")

        print(f"üîç [user-prompt-submit] Prompt length: {len(prompt)}", file=sys.stderr)

        # Get repository root
        try:
            repo_root = get_repo_root()
            print(f"üîç [user-prompt-submit] Repo root: {repo_root}", file=sys.stderr)
        except Exception as e:
            print(f"‚ö†Ô∏è  [user-prompt-submit] ERROR getting repo root: {e}", file=sys.stderr)
            print(json.dumps({"continue": True}))
            return

        # Get recently modified files from git
        try:
            result = subprocess.run(
                ["git", "diff", "--name-only", "HEAD"],
                capture_output=True,
                text=True,
                cwd=str(repo_root)
            )
            modified_files = result.stdout.strip().split('\n') if result.stdout else []
            print(f"üîç [user-prompt-submit] Modified files: {len(modified_files)}", file=sys.stderr)
        except Exception as e:
            print(f"‚ö†Ô∏è  [user-prompt-submit] ERROR getting modified files: {e}", file=sys.stderr)
            modified_files = []

        # Load skills and check triggers
        try:
            skill_rules = load_skill_rules()
            print(f"üîç [user-prompt-submit] Loaded {len(skill_rules)} skill rules", file=sys.stderr)
        except Exception as e:
            print(f"‚ö†Ô∏è  [user-prompt-submit] ERROR loading skill rules: {e}", file=sys.stderr)
            print(json.dumps({"continue": True}))
            return

        activated_skills = []

        for skill_name, skill_config in skill_rules.items():
            if check_prompt_triggers(prompt, skill_config):
                activated_skills.append((skill_name, "prompt"))
            elif check_file_triggers(modified_files, skill_config):
                activated_skills.append((skill_name, "file"))

        if not activated_skills:
            # No skills activated - continue without message
            print(f"‚úÖ [user-prompt-submit] No skills activated", file=sys.stderr)
            print(json.dumps({"continue": True}))
            return

        print(f"‚úÖ [user-prompt-submit] Activated {len(activated_skills)} skills", file=sys.stderr)

        # Generate skill activation message
        activation_msg = "\nüéØ **Skill Activation Check**\n\n"
        for skill_name, trigger_type in activated_skills:
            activation_msg += f"- Use `{skill_name}` skill (triggered by {trigger_type})\n"

        # Return as system message
        print(json.dumps({
            "continue": True,
            "systemMessage": activation_msg
        }))

    except Exception as e:
        # Never block - report error as system message and continue
        import traceback
        import os
        error_details = traceback.format_exc()
        print(f"‚ö†Ô∏è  [user-prompt-submit] EXCEPTION: {e}", file=sys.stderr)
        print(f"‚ö†Ô∏è  [user-prompt-submit] Traceback:\n{error_details}", file=sys.stderr)

        error_msg = f"\n‚ö†Ô∏è **Skill Activation Hook Error**\n\n```\n{str(e)}\n\nWorking directory: {os.getcwd()}\n```\n\n*Hook continuing anyway...*\n"
        print(json.dumps({
            "continue": True,
            "systemMessage": error_msg
        }))


if __name__ == "__main__":
    main()
