#!/usr/bin/env python
"""
Saves session state before compaction.
Creates a session summary with key context to restore after compact.
"""
import json
import os
import subprocess
import sys
import traceback
from datetime import datetime
from pathlib import Path


def get_repo_root():
    """Get git repository root directory"""
    print(f"üîç [pre-compact] Getting repo root from: {os.getcwd()}", file=sys.stderr)
    result = subprocess.run(
        ["git", "rev-parse", "--show-toplevel"],
        capture_output=True,
        text=True
    )
    if result.returncode != 0:
        raise Exception(f"git rev-parse failed: {result.stderr}")
    root = Path(result.stdout.strip())
    print(f"üîç [pre-compact] Repo root: {root}", file=sys.stderr)
    return root


def main():
    try:
        print(f"üîç [pre-compact] Starting from: {os.getcwd()}", file=sys.stderr)

        hook_input = json.loads(sys.stdin.read())
        print(f"üîç [pre-compact] Session ID: {hook_input.get('session_id', 'N/A')}", file=sys.stderr)

        # Create session archive in repo root
        repo_root = get_repo_root()
        session_dir = repo_root / ".claude/sessions"
        session_dir.mkdir(exist_ok=True)

        timestamp = datetime.now().strftime("%Y-%m-%d-%H%M%S")
        session_file = session_dir / f"session-{timestamp}.json"

        # Save session metadata
        with open(session_file, "w") as f:
            json.dump(
                {
                    "timestamp": timestamp,
                    "cwd": hook_input["cwd"],
                    "session_id": hook_input["session_id"],
                    "transcript_path": hook_input.get("transcript_path"),
                },
                f,
                indent=2,
            )

        print(f"‚úÖ [pre-compact] Complete - saved to {session_file}", file=sys.stderr)
        print(f"üíæ Session state saved to {session_file}")

    except Exception as e:
        error_details = traceback.format_exc()
        print(f"‚ö†Ô∏è  [pre-compact] EXCEPTION: {e}", file=sys.stderr)
        print(f"‚ö†Ô∏è  [pre-compact] Traceback:\n{error_details}", file=sys.stderr)

        # Never block - just print error
        print(f"‚ö†Ô∏è  Pre-compact save failed: {e}\nWorking directory: {os.getcwd()}")


if __name__ == "__main__":
    main()
