#!/usr/bin/env python
"""
Track slash command usage, outcomes, and quality metrics.
Logs to .claude/metrics/ for analysis.
"""
import json
import os
import sys
from datetime import datetime
from pathlib import Path


def get_repo_root():
    """Get git repository root directory"""
    import subprocess
    result = subprocess.run(
        ["git", "rev-parse", "--show-toplevel"],
        capture_output=True,
        text=True
    )
    if result.returncode != 0:
        return Path.home() / "dotfiles"  # Fallback
    return Path(result.stdout.strip())


def extract_slash_command(transcript_path):
    """Extract last slash command from transcript"""
    try:
        with open(transcript_path, 'r') as f:
            for line in f:
                try:
                    entry = json.loads(line)
                    if entry.get('type') == 'user_message':
                        content = entry.get('content', '')
                        if content.startswith('/'):
                            return content.split()[0], content
                except json.JSONDecodeError:
                    continue
    except Exception:
        pass
    return None, None


def count_errors_in_output(output_text):
    """Count error indicators in command output"""
    error_keywords = ['error:', 'failed:', 'exception:', 'traceback:', '[error]', '[fail]']
    warning_keywords = ['warning:', 'warn:', '[warning]', '[warn]']

    errors = sum(1 for line in output_text.lower().split('\n')
                 if any(kw in line for kw in error_keywords))
    warnings = sum(1 for line in output_text.lower().split('\n')
                   if any(kw in line for kw in warning_keywords))

    return errors, warnings


def main():
    try:
        hook_input = json.loads(sys.stdin.read())

        # Extract relevant data
        session_id = hook_input.get('session_id', 'unknown')
        transcript_path = hook_input.get('transcript_path')
        cwd = hook_input.get('cwd', os.getcwd())

        # Try to extract slash command used
        command, full_content = extract_slash_command(transcript_path) if transcript_path else (None, None)

        if not command or not command.startswith('/logsift'):
            # Only track logsift commands for now
            sys.exit(0)

        # Create metrics directory
        repo_root = get_repo_root()
        metrics_dir = repo_root / ".claude/metrics"
        metrics_dir.mkdir(parents=True, exist_ok=True)

        # Create timestamped log entry
        timestamp = datetime.now().isoformat()
        metric_entry = {
            "timestamp": timestamp,
            "session_id": session_id,
            "command": command,
            "full_command": full_content,
            "cwd": cwd,
            "type": "logsift-auto" if "logsift-auto" in command else "logsift",
        }

        # Append to daily log file
        date_str = datetime.now().strftime("%Y-%m-%d")
        log_file = metrics_dir / f"command-metrics-{date_str}.jsonl"

        with open(log_file, 'a') as f:
            f.write(json.dumps(metric_entry) + '\n')

        print(f"üìä Logged command metrics to {log_file}", file=sys.stderr)

    except Exception as e:
        print(f"‚ö†Ô∏è  Metrics tracking failed: {e}", file=sys.stderr)
        # Never block
        pass


if __name__ == "__main__":
    main()
