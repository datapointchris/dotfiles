#!/usr/bin/env bash
# Stop hook to remind about commits made during the session

# Extensive error handling - NEVER block Claude Code
set +e  # Don't exit on error
exec 2>&1  # Redirect stderr to stdout for better logging

# Log initial state
echo "ðŸ” [stop-commit-reminder] Starting from: $(pwd)" >&2

# Get repository root and change to it
if ! REPO_ROOT=$(git rev-parse --show-toplevel 2>&1); then
    echo "âš ï¸  [stop-commit-reminder] ERROR: Not in a git repository" >&2
    echo "   Working directory: $(pwd)" >&2
    exit 0  # Non-blocking
fi

if ! cd "$REPO_ROOT" 2>&1; then
    echo "âš ï¸  [stop-commit-reminder] ERROR: Cannot cd to $REPO_ROOT" >&2
    exit 0  # Non-blocking
fi

echo "ðŸ” [stop-commit-reminder] Repo root: $REPO_ROOT" >&2

# Read stdin (hook input) but we don't need it for this check
cat > /dev/null 2>&1 || true

# Check if any commits were made in the last minute
# (Assumes Claude's response took less than 1 minute to complete)
RECENT_COMMITS=$(git log --since="1 minute ago" --oneline --no-merges 2>/dev/null | wc -l | tr -d ' ')

if [[ $RECENT_COMMITS -eq 0 ]]; then
    # No commits made, nothing to remind
    echo "âœ… [stop-commit-reminder] No recent commits" >&2
    exit 0
fi

# Check if changelog files were modified in recent commits
CHANGELOG_MODIFIED=$(git log --since="1 minute ago" --name-only --oneline --no-merges 2>/dev/null | grep -c "docs/changelog" || echo "0")

# If commits were made but changelog wasn't updated, show reminder
if [[ $RECENT_COMMITS -gt 0 ]] && [[ $CHANGELOG_MODIFIED -eq 0 ]]; then
    echo ""
    echo "ðŸ“ **Reminder**: $RECENT_COMMITS commit(s) made during this response"
    echo ""
    echo "Commits will be logged for changelog tracking."
    echo "Remember to update changelog when you have 3+ pending commits."
    echo ""
fi

echo "âœ… [stop-commit-reminder] Complete" >&2
exit 0
