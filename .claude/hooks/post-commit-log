#!/usr/bin/env bash
# Post-commit hook to log significant commits for changelog tracking

set -euo pipefail

# Get commit info
COMMIT_HASH=$(git rev-parse --short HEAD)
COMMIT_MSG=$(git log -1 --pretty=%B)
COMMIT_DATE=$(date +%Y-%m-%d)
COMMIT_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)
FILE_COUNT=$(echo "$COMMIT_FILES" | wc -l | tr -d ' ')

# Extract commit type if using conventional commits
COMMIT_TYPE=""
if [[ "$COMMIT_MSG" =~ ^([a-z]+)(\(.+\))?:\ .+ ]]; then
    COMMIT_TYPE="${BASH_REMATCH[1]}"
fi

# Skip trivial commits
SKIP_TYPES="chore|style|typo|deps|ci|build"
if [[ "$COMMIT_TYPE" =~ ^($SKIP_TYPES)$ ]]; then
    # echo "  (skipped changelog: $COMMIT_TYPE commit)" >&2
    exit 0
fi

# Skip WIP and temporary commits
if [[ "$COMMIT_MSG" =~ ^(WIP|TODO|TEMP|fixup|squash) ]]; then
    # echo "  (skipped changelog: temporary commit)" >&2
    exit 0
fi

# Skip if only lock files or single trivial file changed
SIGNIFICANT=0
while IFS= read -r file; do
    if [[ -z "$file" ]]; then
        continue
    fi

    # Skip lock files and generated files
    if [[ "$file" =~ \.(lock|pyc)$ ]] || [[ "$file" == *"__pycache__"* ]]; then
        continue
    fi

    # Skip single-line markdown changes
    if [[ "$file" =~ \.md$ ]] && [[ $FILE_COUNT -eq 1 ]]; then
        LINES_CHANGED=$(git diff HEAD~1 HEAD -- "$file" | grep -c "^[+-]" || echo "0")
        if [[ $LINES_CHANGED -lt 3 ]]; then
            continue
        fi
    fi

    # Found significant file
    SIGNIFICANT=1
    break
done <<< "$COMMIT_FILES"

if [[ $SIGNIFICANT -eq 0 ]]; then
    # echo "  (skipped changelog: no significant changes)" >&2
    exit 0
fi

# Skip if commit only modified changelog files
CHANGELOG_ONLY=1
while IFS= read -r file; do
    if [[ -z "$file" ]]; then
        continue
    fi
    if [[ ! "$file" =~ ^docs/changelog/ ]] && [[ ! "$file" == "docs/changelog.md" ]]; then
        CHANGELOG_ONLY=0
        break
    fi
done <<< "$COMMIT_FILES"

if [[ $CHANGELOG_ONLY -eq 1 ]]; then
    # echo "  (skipped changelog: changelog-only commit)" >&2
    exit 0
fi

# Log to pending changelog
PENDING_FILE=".claude/.pending-changelog"
mkdir -p .claude
echo "$COMMIT_HASH|$COMMIT_MSG|$COMMIT_DATE" >> "$PENDING_FILE"

echo "âœ“ Commit logged - changelog update pending" >&2
