#!/usr/bin/env python3
"""
PostToolUse hook for Task tool - extracts agent metrics from transcript.

Receives hook context via stdin, extracts agent transcript path, and calls
the metrics extraction library to log comprehensive agent performance data.
"""

import sys
import json
from pathlib import Path
from datetime import datetime

# Debug logging
debug_log = Path("/tmp/post-task-hook-debug.log")
with open(debug_log, "a") as f:
    f.write(f"\n=== Hook called at {datetime.now()} ===\n")

# Read hook context from stdin
try:
    hook_context = json.load(sys.stdin)
    with open(debug_log, "a") as f:
        f.write(f"Hook context: {json.dumps(hook_context, indent=2)}\n")
except Exception as e:
    with open(debug_log, "a") as f:
        f.write(f"Error reading stdin: {e}\n")
    sys.exit(0)

hook_context = hook_context if 'hook_context' in locals() else {}

# Get session_id from context
session_id = hook_context.get("session_id")

if not session_id:
    # No session_id, can't proceed
    sys.exit(0)

# Construct context file path
context_file = Path(f"/tmp/claude-agent-context-{session_id}.json")

if not context_file.exists():
    # Context file doesn't exist, nothing to extract
    sys.exit(0)

# Call the metrics extraction script
import subprocess
script_path = Path(__file__).parent.parent / "lib" / "extract_agent_metrics.py"
subprocess.run(
    [
        "python3",
        str(script_path),
        "--context-file",
        str(context_file)
    ],
    capture_output=True  # Suppress output
)

sys.exit(0)
