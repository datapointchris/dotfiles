# ================================================================
# tenv (Terraform/OpenTofu Version Manager) Tasks
# ================================================================
# Manages Terraform installation via tenv
# Cross-platform: macOS, WSL, Arch
#
# For simple tenv commands, use tenv directly:
#   tenv tf list                # List installed versions
#   tenv tf list-remote         # List available versions
#   tenv tf use <version>       # Switch version
#   tenv tf uninstall <version> # Remove version
#   tenv tf detect              # Show version for current directory

version: '3'

vars:
  PACKAGES_CONFIG: "{{.ROOT_DIR}}/management/packages.yml"
  # TERRAFORM_VERSION is read at runtime in install-terraform task via Python parser

tasks:
  # ================================================================
  # INSTALLATION
  # ================================================================

  install:
    desc: Install tenv and Terraform
    silent: true
    cmds:
      - task: check-installed
      - task: install-terraform

  check-installed:
    internal: true
    silent: true
    cmds:
      - bash {{.ROOT_DIR}}/management/scripts/install-tenv.sh

  install-terraform:
    desc: Install Terraform using tenv
    silent: true
    cmds:
      - |
        # Read Terraform version from packages.yml using Python parser
        TERRAFORM_VERSION=$(/usr/bin/python3 {{.ROOT_DIR}}/management/parse-packages.py --get=runtimes.terraform.version)
        echo "✅ Installing Terraform ${TERRAFORM_VERSION}..."

        # Check if tenv is available
        if ! command -v tenv >/dev/null 2>&1; then
          echo "❌ tenv not found in PATH. Please ensure tenv is installed and in PATH."
          exit 1
        fi

        # Install specific Terraform version
        tenv tf install "${TERRAFORM_VERSION}"

        # Set as default version
        tenv tf use "${TERRAFORM_VERSION}"

        echo "✅ Terraform ${TERRAFORM_VERSION} installed and set as default"

  install-latest:
    desc: Install latest Terraform version
    silent: true
    cmds:
      - echo "✅ Installing latest Terraform..."
      - tenv tf install latest
      - tenv tf use latest
      - echo "✅ Latest Terraform installed"

  # ================================================================
  # UPDATE
  # ================================================================

  update:
    desc: Update Terraform to version from packages.yml
    silent: true
    cmds:
      - task: install-terraform
