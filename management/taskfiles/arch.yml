version: '3'

vars: {}

includes:
  npm-global:
    taskfile: ./npm-global.yml
  uv-tools:
    taskfile: ./uv-tools.yml
  shell-plugins:
    taskfile: ./shell-plugins.yml
  cargo:
    taskfile: ./cargo-update.yml
  tmux:
    taskfile: ./tmux-plugins.yml
  pacman:
    taskfile: ./pacman.yml
  yay:
    taskfile: ./yay.yml

tasks:

  install-packages:
    desc: Install system packages via pacman
    silent: true
    cmds:
      - echo "✅ Installing Arch Linux packages..."
      - echo "  Updating package database..."
      - sudo pacman -Sy
      - task: install-system-packages
      - task: fix-library-links
      - task: install-aur-helper
      - echo "✅ Arch packages installed!"

  install-system-packages:
    internal: true
    silent: true
    cmds:
      - |
        echo "  Installing bootstrap packages..."
        # Bootstrap: Install python-yaml first (needed for parse-packages.py)
        sudo pacman -S --needed --noconfirm python-yaml

        echo "  Installing system packages from packages.yml..."
        # Get package list from packages.yml via Python parser
        PACKAGES=$(/usr/bin/python3 {{.ROOT_DIR}}/management/parse-packages.py --type=system --manager=pacman | tr '\n' ' ')
        echo "  Packages: $PACKAGES"
        sudo pacman -S --needed --noconfirm $PACKAGES

  fix-library-links:
    desc: Fix library linking issues (pcre2 for git)
    internal: true
    silent: true
    cmds:
      - |
        echo "  Fixing library links..."
        # Fix pcre2 version symbols for git
        # This resolves "no version information available" warnings

        # Reinstall pcre2 to ensure proper version symbols
        sudo pacman -S --noconfirm pcre2 2>/dev/null || true

        # Rebuild library cache to ensure proper linking
        sudo ldconfig 2>/dev/null || true

        echo "  Library links fixed"

  install-aur-helper:
    desc: Install yay (AUR helper)
    cmds:
      - |
        if command -v yay >/dev/null 2>&1; then
          echo " yay already installed"
        else
          echo " Installing yay AUR helper..."
          cd /tmp
          git clone https://aur.archlinux.org/yay.git
          cd yay
          makepkg -si --noconfirm
          cd ~
          rm -rf /tmp/yay
          echo " yay installed"
        fi
    status:
      - command -v yay >/dev/null 2>&1

  install-aur-packages:
    desc: Install packages from AUR
    deps:
      - install-aur-helper
    cmds:
      - |
        echo " Installing AUR packages..."

        # Install AUR packages here
        # yay -S --needed --noconfirm <package-name>

        echo " No AUR packages configured yet"
        echo " AUR packages installed!"

  install-desktop:
    desc: Install desktop environment (optional)
    cmds:
      - |
        echo " Desktop environment installation not configured"
        echo " Common options"
        echo "   - GNOME: sudo pacman -S gnome gnome-extra"
        echo "   - KDE: sudo pacman -S plasma kde-applications"
        echo "   - i3: sudo pacman -S i3-wm i3status i3lock dmenu"

  update-all:
    desc: Update all Arch Linux packages and tools
    silent: true
    cmds:
      - task: check-core-components
      - task: run-updates

  check-core-components:
    desc: Verify core package managers are installed
    internal: true
    silent: true
    preconditions:
      - sh: command -v pacman >/dev/null 2>&1
        msg: |
          ERROR: pacman is not installed (core component)
          This should not happen on Arch - your system may be broken
      - sh: command -v npm >/dev/null 2>&1
        msg: |
          ERROR: npm is not installed (core component)
          Install Node.js with: task nvm:install
      - sh: command -v uv >/dev/null 2>&1
        msg: |
          ERROR: uv is not installed (core component)
          Install with: curl -LsSf https://astral.sh/uv/install.sh | sh

  run-updates:
    desc: Run all update tasks
    internal: true
    silent: true
    cmds:
      - bash {{.ROOT_DIR}}/management/scripts/update-arch.sh

  # ================================================================
  # ARCH-SPECIFIC CONFIGURATION
  # ================================================================

  configure:
    desc: Apply Arch-specific configurations
    silent: true
    cmds:
      - echo "✅ Configuring Arch Linux..."
      - task: configure-pacman
      - echo "✅ Arch configured!"

  configure-pacman:
    internal: true
    silent: true
    cmds:
      - |
        echo "  Configuring pacman..."

        # Enable color output
        sudo sed -i 's/#Color/Color/' /etc/pacman.conf

        # Enable parallel downloads
        sudo sed -i 's/#ParallelDownloads/ParallelDownloads/' /etc/pacman.conf

        echo " pacman configured"

  # ================================================================
  # UTILITIES
  # ================================================================
  # For system maintenance, use pacman directly:
  #   sudo pacman -Syu                         # Update system
  #   sudo pacman -Sc                          # Clean cache
  #   sudo pacman -Rns $(pacman -Qtdq)         # Remove orphans
  #   pacman -Q | wc -l                        # Count packages
  #   uname -r                                 # Show kernel version

  # ================================================================
  # SERVICES
  # ================================================================

  enable-services:
    desc: Enable essential services
    silent: true
    cmds:
      - |
        echo "✅ Enabling services..."

        # Network
        sudo systemctl enable NetworkManager
        sudo systemctl start NetworkManager

        # SSH (if needed)
        # sudo systemctl enable sshd
        # sudo systemctl start sshd

        echo "✅ Services enabled"
