# ================================================================
# NVM (Node Version Manager) Tasks
# ================================================================
# Manages Node.js installation via nvm
# Cross-platform: macOS, WSL, Arch
#
# For simple nvm commands, use nvm directly:
#   nvm list                    # List installed versions
#   nvm list-remote --lts       # List available versions
#   nvm current                 # Show current version
#   nvm use <version>           # Switch version
#   nvm cache clear             # Clear cache
#   nvm uninstall <version>     # Remove version

version: '3'

vars:
  NVM_DIR: "{{.HOME}}/.config/nvm"
  NVM_INSTALL_SCRIPT: "https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.0/install.sh"
  PACKAGES_CONFIG: "{{.ROOT_DIR}}/management/packages.yml"
  # NODE_VERSION is read at runtime in install-node task via Python parser

tasks:
  # ================================================================
  # INSTALLATION
  # ================================================================

  install:
    desc: Install nvm and Node.js
    silent: true
    cmds:
      - task: check-installed
      - task: install-node

  check-installed:
    internal: true
    silent: true
    cmds:
      - |
        if [[ ! -d "{{.NVM_DIR}}" ]]; then
          echo "✅ Installing nvm..."
          mkdir -p "{{.NVM_DIR}}"
          curl -o- {{.NVM_INSTALL_SCRIPT}} | NVM_DIR={{.NVM_DIR}} bash
          echo "✅ nvm installed at {{.NVM_DIR}}"
        else
          echo "✅ nvm already installed"
        fi

  install-node:
    desc: Install Node.js using nvm
    silent: true
    cmds:
      - |
        # Read Node version from packages.yml using Python parser
        NODE_VERSION=$(python3 {{.ROOT_DIR}}/management/parse-packages.py --get=runtimes.node.version)
        echo "✅ Installing Node.js ${NODE_VERSION}..."
        NVM_DIR={{.NVM_DIR}} {{.ROOT_DIR}}/management/scripts/nvm-install-node.sh "${NODE_VERSION}"
        echo "✅ Node.js ${NODE_VERSION} installed and set as default"

  install-latest-lts:
    desc: Install latest LTS Node.js version
    silent: true
    cmds:
      - echo "✅ Installing latest LTS Node.js..."
      - NVM_DIR={{.NVM_DIR}} {{.ROOT_DIR}}/management/scripts/nvm-install-lts.sh
      - echo "✅ Latest LTS Node.js installed"

  # ================================================================
  # UPDATE
  # ================================================================
  # To update nvm itself, use git directly:
  #   cd ~/.config/nvm
  #   git fetch --tags origin
  #   git checkout `git describe --abbrev=0 --tags`
