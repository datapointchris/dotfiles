version: '3'

set: [pipefail]

vars:
  DOTFILES_DIR:
    sh: pwd
  SYMLINKS_DIR: '{{.DOTFILES_DIR}}/management/symlinks'
  PLATFORM:
    sh: |
      if [ -f "$HOME/.env" ]; then
        source "$HOME/.env" && echo "$PLATFORM"
      elif [ "$(uname)" = "Darwin" ]; then
        echo "macos"
      else
        echo "linux"
      fi

tasks:
  link:
    desc: Create symlinks for dotfiles (common + platform layers)
    silent: false
    dir: '{{.SYMLINKS_DIR}}'
    env:
      UV_PROJECT: '{{.SYMLINKS_DIR}}'
    cmds:
      - uv run symlinks relink {{.PLATFORM}}

  link-common:
    desc: Create symlinks for common layer only
    silent: false
    dir: '{{.SYMLINKS_DIR}}'
    env:
      UV_PROJECT: '{{.SYMLINKS_DIR}}'
    cmds:
      - uv run symlinks link common

  link-platform:
    desc: Create symlinks for platform layer only
    silent: false
    dir: '{{.SYMLINKS_DIR}}'
    env:
      UV_PROJECT: '{{.SYMLINKS_DIR}}'
    cmds:
      - uv run symlinks link {{.PLATFORM}}

  unlink:
    desc: Remove all symlinks (common + platform layers)
    silent: false
    dir: '{{.SYMLINKS_DIR}}'
    env:
      UV_PROJECT: '{{.SYMLINKS_DIR}}'
    cmds:
      - uv run symlinks unlink {{.PLATFORM}}
      - uv run symlinks unlink common

  unlink-common:
    desc: Remove symlinks for common layer only
    silent: false
    dir: '{{.SYMLINKS_DIR}}'
    env:
      UV_PROJECT: '{{.SYMLINKS_DIR}}'
    cmds:
      - uv run symlinks unlink common

  unlink-platform:
    desc: Remove symlinks for platform layer only
    silent: false
    dir: '{{.SYMLINKS_DIR}}'
    env:
      UV_PROJECT: '{{.SYMLINKS_DIR}}'
    cmds:
      - uv run symlinks unlink {{.PLATFORM}}

  show:
    desc: Show current symlinks
    silent: false
    dir: '{{.SYMLINKS_DIR}}'
    env:
      UV_PROJECT: '{{.SYMLINKS_DIR}}'
    cmds:
      - uv run symlinks show

  show-common:
    desc: Show common layer symlinks
    silent: false
    dir: '{{.SYMLINKS_DIR}}'
    env:
      UV_PROJECT: '{{.SYMLINKS_DIR}}'
    cmds:
      - uv run symlinks show common

  show-platform:
    desc: Show platform layer symlinks
    silent: false
    dir: '{{.SYMLINKS_DIR}}'
    env:
      UV_PROJECT: '{{.SYMLINKS_DIR}}'
    cmds:
      - uv run symlinks show {{.PLATFORM}}

  check:
    desc: Check for broken symlinks
    silent: false
    dir: '{{.SYMLINKS_DIR}}'
    env:
      UV_PROJECT: '{{.SYMLINKS_DIR}}'
    cmds:
      - uv run symlinks check

  check-clean:
    desc: Check and remove broken symlinks
    silent: false
    dir: '{{.SYMLINKS_DIR}}'
    env:
      UV_PROJECT: '{{.SYMLINKS_DIR}}'
    cmds:
      - uv run symlinks check --clean

  info:
    desc: Show dotfiles configuration
    silent: false
    dir: '{{.SYMLINKS_DIR}}'
    env:
      UV_PROJECT: '{{.SYMLINKS_DIR}}'
    cmds:
      - uv run symlinks info

  relink:
    desc: Complete refresh (unlink, check, link everything)
    silent: false
    dir: '{{.SYMLINKS_DIR}}'
    env:
      UV_PROJECT: '{{.SYMLINKS_DIR}}'
    cmds:
      - uv run symlinks relink {{.PLATFORM}}
