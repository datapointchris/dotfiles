version: '3'

vars:
  HOMEBREW_PREFIX: "/usr/local"

includes:
  brew:
    taskfile: ./brew.yml
  npm-global:
    taskfile: ./npm-global.yml
  uv-tools:
    taskfile: ./uv-tools.yml
  shell-plugins:
    taskfile: ./shell-plugins.yml
  cargo:
    taskfile: ./cargo-update.yml
  mas:
    taskfile: ./mas.yml
  tmux:
    taskfile: ./tmux-plugins.yml

tasks:

  install-homebrew:
    desc: Install Homebrew (if not present)
    silent: true
    cmds:
      - |
        if command -v brew >/dev/null 2>&1; then
          echo "Homebrew already installed"
        else
          echo "Installing Homebrew..."
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "✅ Homebrew installed"
        fi
    status:
      - command -v brew >/dev/null 2>&1

  install-xcode-tools:
    desc: Install Xcode Command Line Tools
    silent: true
    cmds:
      - |
        if xcode-select -p &>/dev/null; then
          echo "Xcode Command Line Tools already installed"
        else
          echo "Installing Xcode Command Line Tools..."
          xcode-select --install
          echo "Complete the installation in the GUI prompt"
          echo "Run 'task macos:install-xcode-tools' again after installation completes"
        fi

  update-all:
    desc: Update all macOS packages and tools
    silent: true
    cmds:
      - task: check-core-components
      - task: run-updates

  check-core-components:
    desc: Verify core package managers are installed
    internal: true
    silent: true
    preconditions:
      - sh: command -v brew >/dev/null 2>&1
        msg: |
          ERROR: Homebrew is not installed (core component)
          Install with: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      - sh: command -v npm >/dev/null 2>&1
        msg: |
          ERROR: npm is not installed (core component)
          Install Node.js with: task nvm:install
      - sh: command -v uv >/dev/null 2>&1
        msg: |
          ERROR: uv is not installed (core component)
          Install with: brew install --cask uv

  run-updates:
    desc: Run all update tasks
    internal: true
    silent: true
    cmds:
      - bash {{.ROOT_DIR}}/management/scripts/update-macos.sh

  # ================================================================
  # MACOS CONFIGURATION
  # ================================================================

  configure:
    desc: Apply macOS system preferences
    silent: true
    cmds:
      - echo "✅ Configuring macOS system preferences..."
      - task: configure-finder
      - task: configure-dock
      - task: configure-keyboard
      - echo "✅ macOS configured!"
      - echo "Some changes may require logout/restart"

  configure-finder:
    desc: Configure Finder preferences
    internal: true
    silent: true
    cmds:
      - |
        echo "  Configuring Finder..."
        # Show hidden files
        defaults write com.apple.finder AppleShowAllFiles -bool true
        # Show file extensions
        defaults write NSGlobalDomain AppleShowAllExtensions -bool true
        # Show path bar
        defaults write com.apple.finder ShowPathbar -bool true
        # Show status bar
        defaults write com.apple.finder ShowStatusBar -bool true
        # Restart Finder
        killall Finder
        echo " Finder configured"

  configure-dock:
    desc: Configure Dock preferences
    internal: true
    silent: true
    cmds:
      - |
        echo "  Configuring Dock..."
        # Auto-hide dock
        defaults write com.apple.dock autohide -bool true
        # Restart Dock
        killall Dock
        echo " Dock configured"

  configure-keyboard:
    desc: Configure keyboard preferences
    internal: true
    silent: true
    cmds:
      - |
        echo "  Configuring keyboard..."
        # Fast key repeat
        defaults write NSGlobalDomain KeyRepeat -int 2
        defaults write NSGlobalDomain InitialKeyRepeat -int 15
        echo " Keyboard configured"

  # ================================================================
  # UTILITIES
  # ================================================================
  # For system maintenance, use native commands directly:
  #   softwareupdate --list                # Check for system updates
  #   softwareupdate --install --all       # Install system updates
  #   brew cleanup                         # Clean Homebrew caches
  #   brew doctor                          # Run Homebrew diagnostics
  #   sw_vers                              # Show macOS version
