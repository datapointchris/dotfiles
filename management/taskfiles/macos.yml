version: '3'

vars:
  HOMEBREW_PREFIX: "/usr/local"

includes:
  brew:
    taskfile: ./brew.yml
  npm-global:
    taskfile: ./npm-global.yml
  uv-tools:
    taskfile: ./uv-tools.yml
  shell-plugins:
    taskfile: ./shell-plugins.yml
  cargo:
    taskfile: ./cargo-update.yml
  mas:
    taskfile: ./mas.yml
  tmux:
    taskfile: ./tmux-plugins.yml
  tenv:
    taskfile: ./tenv.yml

tasks:

  install-homebrew:
    desc: Install Homebrew (if not present)
    silent: true
    cmds:
      - |
        if command -v brew >/dev/null 2>&1; then
          echo "Homebrew already installed"
        else
          echo "Installing Homebrew..."
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "✅ Homebrew installed"
        fi
    status:
      - command -v brew >/dev/null 2>&1

  setup-xcode:
    desc: Accept Xcode license and run first launch setup
    silent: true
    cmds:
      - |
        if ! command -v xcodebuild &>/dev/null; then
          echo "⚠️  Xcode not installed (install via: mas install 497799835)"
          exit 0
        fi

        echo "Setting up Xcode..."

        # Check if license is already accepted
        if sudo -n xcodebuild -license status &>/dev/null; then
          echo "  ✓ Xcode license already accepted"
        else
          echo "  ⚠️  Xcode license not accepted"
          echo "  ℹ️  Run manually: sudo xcodebuild -license accept"
          exit 0
        fi

        # Run first launch setup
        echo "  Running first launch setup..."
        xcodebuild -runFirstLaunch 2>/dev/null || true

        echo "✅ Xcode setup complete"

  install-python-yaml:
    desc: Install PyYAML for system Python (bootstrap dependency)
    silent: true
    cmds:
      - |
        if /usr/bin/python3 -c "import yaml" &>/dev/null; then
          echo "PyYAML already installed for system Python"
        else
          echo "Installing PyYAML for system Python..."
          /usr/bin/python3 -m pip install --user PyYAML
          echo "✅ PyYAML installed"
        fi

  install-packages:
    desc: Install system packages from packages.yml via Homebrew
    silent: true
    cmds:
      - echo "✅ Installing macOS packages from packages.yml..."
      - task: install-python-yaml
      - task: install-system-packages
      - task: setup-docker-compose
      - echo "✅ macOS packages installed!"

  install-system-packages:
    internal: true
    silent: true
    cmds:
      - |
        echo "  Installing system packages from packages.yml..."
        PACKAGES=$(/usr/bin/python3 {{.ROOT_DIR}}/management/parse-packages.py --type=system --manager=brew | tr '\n' ' ')
        echo "  Packages: $PACKAGES"
        brew install $PACKAGES

  update-all:
    desc: Update all macOS packages and tools
    silent: true
    cmds:
      - task: check-core-components
      - task: run-updates

  check-core-components:
    desc: Verify core package managers are installed
    internal: true
    silent: true
    preconditions:
      - sh: command -v brew >/dev/null 2>&1
        msg: |
          ERROR: Homebrew is not installed (core component)
          Install with: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      - sh: command -v npm >/dev/null 2>&1
        msg: |
          ERROR: npm is not installed (core component)
          Install Node.js with: task nvm:install
      - sh: command -v uv >/dev/null 2>&1
        msg: |
          ERROR: uv is not installed (core component)
          Install with: brew install --cask uv

  run-updates:
    desc: Run all update tasks
    internal: true
    silent: true
    cmds:
      - bash {{.ROOT_DIR}}/management/scripts/update-macos.sh

  # ================================================================
  # MACOS CONFIGURATION
  # ================================================================

  configure:
    desc: Apply macOS system preferences
    silent: true
    cmds:
      - echo "✅ Configuring macOS system preferences..."
      - task: configure-finder
      - task: configure-dock
      - task: configure-keyboard
      - echo "✅ macOS configured!"
      - echo "Some changes may require logout/restart"

  configure-finder:
    desc: Configure Finder preferences
    internal: true
    silent: true
    cmds:
      - |
        echo "  Configuring Finder..."
        # Show hidden files
        defaults write com.apple.finder AppleShowAllFiles -bool true
        # Show file extensions
        defaults write NSGlobalDomain AppleShowAllExtensions -bool true
        # Show path bar
        defaults write com.apple.finder ShowPathbar -bool true
        # Show status bar
        defaults write com.apple.finder ShowStatusBar -bool true
        # Restart Finder
        killall Finder
        echo " Finder configured"

  configure-dock:
    desc: Configure Dock preferences
    internal: true
    silent: true
    cmds:
      - |
        echo "  Configuring Dock..."
        # Auto-hide dock
        defaults write com.apple.dock autohide -bool true
        # Restart Dock
        killall Dock
        echo " Dock configured"

  configure-keyboard:
    desc: Configure keyboard preferences
    internal: true
    silent: true
    cmds:
      - |
        echo "  Configuring keyboard..."
        # Fast key repeat
        defaults write NSGlobalDomain KeyRepeat -int 2
        defaults write NSGlobalDomain InitialKeyRepeat -int 15
        echo " Keyboard configured"

  setup-docker-compose:
    desc: Setup docker-compose as Docker CLI plugin (enables 'docker compose' command)
    silent: true
    # NOTE: This setup is macOS-specific because:
    # - macOS uses Colima (VM-based container runtime) instead of native Docker
    # - Requires manual plugin symlink to DOCKER_CONFIG/cli-plugins/
    # - Linux uses docker-compose-plugin from package repos (automatic setup)
    # See docs/configuration/docker.md for full details on platform differences
    cmds:
      - |
        if ! command -v docker-compose >/dev/null 2>&1; then
          echo "⚠️  docker-compose not installed (run: brew install docker-compose)"
          exit 1
        fi

        echo "Setting up docker-compose as Docker CLI plugin..."

        # Create plugin directory (DOCKER_CONFIG is set in zshrc to $XDG_CONFIG_HOME/docker)
        mkdir -p "${DOCKER_CONFIG:-$HOME/.config/docker}/cli-plugins"

        # Create symlink to enable 'docker compose' command
        ln -sfn $(brew --prefix)/opt/docker-compose/bin/docker-compose \
          "${DOCKER_CONFIG:-$HOME/.config/docker}/cli-plugins/docker-compose"

        echo "✅ docker-compose plugin configured"
        echo "You can now use 'docker compose' (modern) instead of 'docker-compose' (legacy)"

  # ================================================================
  # UTILITIES
  # ================================================================
  # For system maintenance, use native commands directly:
  #   softwareupdate --list                # Check for system updates
  #   softwareupdate --install --all       # Install system updates
  #   brew cleanup                         # Clean Homebrew caches
  #   brew doctor                          # Run Homebrew diagnostics
  #   sw_vers                              # Show macOS version
