version: '3'

vars:
  # Installation directories (user space)
  LOCAL_BIN: "{{.HOME}}/.local/bin"
  LOCAL_DIR: "{{.HOME}}/.local"
  CARGO_HOME: "{{.HOME}}/.cargo"
  TMP_DIR: "/tmp"

includes:
  npm-global:
    taskfile: ./npm-global.yml
  uv-tools:
    taskfile: ./uv-tools.yml
  shell-plugins:
    taskfile: ./shell-plugins.yml
  cargo:
    taskfile: ./cargo-update.yml
  tmux:
    taskfile: ./tmux-plugins.yml
  apt:
    taskfile: ./apt.yml
  tenv:
    taskfile: ./tenv.yml

tasks:

  install-packages:
    desc: Install system packages via apt
    silent: true
    cmds:
      - echo "✅ Installing WSL Ubuntu packages..."
      - echo "  Updating package lists..."
      - sudo apt update
      - task: install-system-packages
      - echo "✅ WSL packages installed!"

  install-system-packages:
    internal: true
    silent: true
    cmds:
      - |
        echo "  Installing bootstrap packages..."
        # Bootstrap: Install python3-yaml first (needed for parse-packages.py)
        sudo apt install -y python3-yaml

        echo "  Installing system packages from packages.yml..."
        PACKAGES=$(/usr/bin/python3 {{.ROOT_DIR}}/management/parse-packages.py --type=system --manager=apt | tr '\n' ' ')
        echo "  Packages: $PACKAGES"
        sudo apt install -y $PACKAGES

  update-all:
    desc: Update all WSL Ubuntu packages and tools
    silent: true
    cmds:
      - task: check-core-components
      - task: run-updates

  check-core-components:
    desc: Verify core package managers are installed
    internal: true
    silent: true
    preconditions:
      - sh: command -v apt >/dev/null 2>&1
        msg: |
          ERROR: apt is not installed (core component)
          This should not happen on Ubuntu - your system may be broken
      - sh: command -v npm >/dev/null 2>&1
        msg: |
          ERROR: npm is not installed (core component)
          Install Node.js with: task nvm:install
      - sh: command -v uv >/dev/null 2>&1
        msg: |
          ERROR: uv is not installed (core component)
          Install with: curl -LsSf https://astral.sh/uv/install.sh | sh

  run-updates:
    desc: Run all update tasks
    internal: true
    silent: true
    cmds:
      - bash {{.ROOT_DIR}}/management/scripts/update-wsl.sh
